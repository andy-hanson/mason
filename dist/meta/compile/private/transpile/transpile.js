if (typeof define !== 'function') var define = require('amdefine')(module);define(['exports', 'esast/dist/ast', 'esast/dist/util', 'esast/dist/specialize', '../../Expression', '../U/Bag', '../U/Op', '../U/util', './esast-util', './transpileObj', './transpileModule', './util'], function (exports, _esastDistAst, _esastDistUtil, _esastDistSpecialize, _Expression, _UBag, _UOp, _UUtil, _esastUtil, _transpileObj, _transpileModule, _util) {
	'use strict';

	var _interopRequire = function (obj) { return obj && obj.__esModule ? obj['default'] : obj; };

	var _slicedToArray = function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i['return']) _i['return'](); } finally { if (_d) throw _e; } } return _arr; } else { throw new TypeError('Invalid attempt to destructure non-iterable instance'); } };

	Object.defineProperty(exports, '__esModule', {
		value: true
	});
	exports.default = transpile;

	var _transpileModule2 = _interopRequire(_transpileModule);

	let cx, vr, isInGenerator;

	function transpile(_cx, e, _vr) {
		cx = _cx;
		vr = _vr;
		isInGenerator = false;
		const res = t(e);
		// Release for garbage collection
		cx = vr = undefined;
		return res;
	}

	const t = function (expr, arg, arg2, arg3) {
		const ast = expr.transpileSubtree(arg, arg2, arg3);
		if (cx.opts.sourceMap() && !(ast instanceof Array))
			// Array is only allowed for statement groups inside of Blocks, such as Debug.
			ast.loc = expr.loc;
		return ast;
	};

	exports.t = t;
	const toStatements = function (_) {
		return _ instanceof Array ? _.map(_esastDistUtil.toStatement) : [_esastDistUtil.toStatement(_)];
	};

	function transpileBlock(lead, opResDeclare, opOut) {
		var _this = this;

		if (lead === undefined) lead = [];
		if (opResDeclare === undefined) opResDeclare = opOut = _UOp.None;
		const body = _UBag.flatMap(this.lines, function (line) {
			return toStatements(t(line));
		});
		const isVal = this instanceof _Expression.BlockVal;
		const fin = _UOp.ifElse(opResDeclare, function (rd) {
			_UUtil.assert(isVal);
			const returned = _util.maybeWrapInCheckContains(cx, t(_this.returned), rd.opType, 'res');
			return _UOp.ifElse(opOut, function (o) {
				return [_esastUtil.declare(rd, returned)].concat(o, [_util.ReturnRes]);
			}, function () {
				return [_esastDistAst.ReturnStatement(returned)];
			});
		}, function () {
			return opOut.concat(_UOp.opIf(isVal, function () {
				return _esastDistAst.ReturnStatement(t(_this.returned));
			}));
		});
		return _esastDistAst.BlockStatement(lead.concat(body, fin));
	}

	_UUtil.implementMany(_Expression, 'transpileSubtree', {
		Assign: function () {
			return _esastDistSpecialize.variableDeclarationConst([_util.makeDeclarator(cx, this.loc, this.assignee, this.k, t(this.value))]);
		},
		// TODO:ES6 Just use native destructuring assign
		AssignDestructure: function () {
			return _esastDistSpecialize.variableDeclarationConst(_util.makeDestructureDeclarators(cx, this.loc, this.assignees, this.isLazy, t(this.value), this.k, false));
		},
		BlockDo: transpileBlock,
		BlockVal: transpileBlock,
		BlockWrap: function () {
			return blockWrap(this, t(this.block));
		},
		Call: function () {
			const anySplat = this.args.some(function (arg) {
				return arg instanceof _Expression.Splat;
			});
			if (anySplat) {
				const args = this.args.map(function (arg) {
					return arg instanceof _Expression.Splat ? _util.msArr([t(arg.splatted)]) : t(arg);
				});
				return _esastDistAst.CallExpression(_util.IdFunctionApplyCall, [t(this.called), _util.LitNull, _esastDistAst.CallExpression(_esastDistUtil.member(_util.LitEmptyArray, 'concat'), args)]);
			} else return _esastDistAst.CallExpression(t(this.called), this.args.map(t));
		},
		CaseDo: function () {
			var _this2 = this;

			return _UOp.ifElse(this.opCased, function (cased) {
				return _esastDistAst.BlockStatement([t(cased), caseBody(_this2.parts, _this2.opElse)]);
			}, function () {
				return caseBody(_this2.parts, _this2.opElse);
			});
		},
		CaseVal: function () {
			const body = caseBody(this.parts, this.opElse);
			const block = _UOp.ifElse(this.opCased, function (cased) {
				return [t(cased), body];
			}, function () {
				return [body];
			});
			return blockWrap(this, _esastDistAst.BlockStatement(block));
		},
		CaseDoPart: function () {
			return casePart(this.test, this.result, true);
		},
		CaseValPart: function () {
			return casePart(this.test, this.result, false);
		},
		// TODO: includeInoutChecks is misnamed
		Debug: function () {
			return cx.opts.includeInoutChecks() ? _UBag.flatMap(this.lines, function (line) {
				return toStatements(t(line));
			}) : [];
		},
		ObjReturn: function () {
			return _transpileObj.transpileObjReturn(this, cx);
		},
		ObjSimple: function () {
			return _transpileObj.transpileObjSimple(this, cx);
		},
		EndLoop: function () {
			return _esastDistAst.BreakStatement(loopId(vr.endLoopToLoop.get(this)));
		},
		Fun: function () {
			const oldInGenerator = isInGenerator;
			isInGenerator = this.k === '~|';

			// TODO:ES6 use `...`
			const nArgs = _esastDistAst.Literal(this.args.length);
			const opDeclareRest = this.opRestArg.map(function (rest) {
				return _esastUtil.declare(rest, _esastDistAst.CallExpression(_util.IdArraySliceCall, [_util.IdArguments, nArgs]));
			});
			const argChecks = _UBag.flatMap(this.args, function (arg) {
				return _util.opLocalCheck(cx, arg, arg.isLazy);
			});
			const _in = _UBag.flatMap(this.opIn, function (i) {
				return toStatements(t(i));
			});
			const lead = opDeclareRest.concat(argChecks, _in);

			const _out = _UBag.flatMap(this.opOut, function (o) {
				return toStatements(t(o));
			});
			const body = t(this.block, lead, this.opResDeclare, _out);
			const args = this.args.map(t);
			const res = _esastDistSpecialize.functionExpressionPlain(args, body, this.k === '~|');

			isInGenerator = oldInGenerator;
			return res;
		},
		Lazy: function () {
			return _util.lazyWrap(t(this.value));
		},
		ListReturn: function () {
			return _esastDistAst.ArrayExpression(_UBag.range(0, this.length).map(function (i) {
				return _esastDistUtil.idCached('_' + i);
			}));
		},
		ListSimple: function () {
			return _esastDistAst.ArrayExpression(this.parts.map(t));
		},
		ListEntry: function () {
			return _esastUtil.declareSpecial('_' + this.index, t(this.value));
		},
		NumberLiteral: function () {
			// Negative numbers are not part of ES spec.
			// http://www.ecma-international.org/ecma-262/5.1/#sec-7.8.3
			const lit = _esastDistAst.Literal(Math.abs(this.value));
			return _UUtil.isPositive(this.value) ? lit : _esastDistSpecialize.unaryExpressionNegate(lit);
		},
		GlobalAccess: function () {
			return _esastDistAst.Identifier(this.name);
		},
		LocalAccess: function () {
			return _util.accessLocal(this, vr);
		},
		LocalDeclare: function () {
			return _esastUtil.idForDeclareCached(this);
		},
		// TODO: Don't always label!
		Loop: function () {
			return _esastDistAst.LabeledStatement(loopId(this), _esastDistSpecialize.whileStatementInfinite(t(this.block)));
		},
		MapReturn: function () {
			return _util.msMap(_UBag.flatMap(_UBag.range(0, this.length), function (i) {
				return [_esastDistUtil.idCached('_k' + i.toString()), _esastDistUtil.idCached('_v' + i.toString())];
			}));
		},
		MapEntry: function () {
			return _esastDistSpecialize.variableDeclarationConst([_esastDistAst.VariableDeclarator(_esastDistUtil.idCached('_k' + this.index), t(this.key)), _esastDistAst.VariableDeclarator(_esastDistUtil.idCached('_v' + this.index), t(this.val))]);
		},
		Member: function () {
			return _esastDistUtil.member(t(this.object), this.name);
		},
		Module: function () {
			return _transpileModule2(this, cx);
		},
		// TODO:ES6 Use `export default`
		ModuleDefaultExport: function () {
			const m = _esastDistUtil.member(_util.IdExports, 'default');
			return _esastDistAst.AssignmentExpression('=', m, t(this.value));
		},
		Quote: function () {
			// TODO:ES6 use template strings
			const part0 = this.parts[0];

			var _ref = typeof part0 === 'string' ? [_esastDistAst.Literal(part0), _UBag.tail(this.parts)] : [_util.LitEmptyString, this.parts];

			var _ref2 = _slicedToArray(_ref, 2);

			const first = _ref2[0];
			const restParts = _ref2[1];

			return restParts.reduce(function (ex, _) {
				return _esastDistSpecialize.binaryExpressionPlus(ex, typeof _ === 'string' ? _esastDistAst.Literal(_) : _util.msShow([t(_)]));
			}, first);
		},
		Special: function () {
			// Make new objects because we will assign `loc` to them.
			switch (this.k) {
				case 'contains':
					return _esastDistUtil.member(_util.IdMs, 'contains');
				case 'debugger':
					return _esastDistAst.DebuggerStatement();
				case 'sub':
					return _esastDistUtil.member(_util.IdMs, 'sub');
				case 'this':
					return _esastDistAst.ThisExpression();
				case 'this-module-directory':
					return _esastDistAst.Identifier('__dirname');
				default:
					throw new Error(this.k);
			}
		},
		Splat: function () {
			cx.fail(this.loc, 'Splat must appear as argument to a call.');
		},
		Yield: function () {
			return _esastDistSpecialize.yieldExpressionNoDelegate(t(this.yielded));
		},
		YieldTo: function () {
			return _esastDistSpecialize.yieldExpressionDelegate(t(this.yieldedTo));
		}
	});

	const blockWrap = function (_, block) {
		const g = isInGenerator;
		const invoke = _esastDistSpecialize.callExpressionThunk(_esastDistSpecialize.functionExpressionThunk(block, g));
		return g ? _esastDistSpecialize.yieldExpressionDelegate(invoke) : invoke;
	};

	const caseFail = _esastDistAst.SwitchCase(null, [_esastUtil.throwError('No branch of `case` matches.')]);
	function caseBody(parts, opElse) {
		const elze = _UOp.ifElse(opElse, function (_) {
			return _esastDistAst.SwitchCase(null, [t(_)]);
		}, function () {
			return caseFail;
		});
		const cases = _UBag.push(parts.map(function (part) {
			return t(part);
		}), elze);
		return _esastDistSpecialize.switchStatementOnTrue(cases);
	}

	function casePart(test, result, needBreak) {
		const checkedTest = cx.opts.includeCaseChecks() ? _util.msBool([t(test)]) : t(test);
		const lines = needBreak ? [t(result), _util.Break] : [t(result)];
		return _esastDistAst.SwitchCase(checkedTest, lines);
	}

	// TODO: MOVE
	const loopId = function (loop) {
		return _esastDistUtil.idCached('loop' + loop.loc.start.line);
	};
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1ldGEvY29tcGlsZS9wcml2YXRlL3RyYW5zcGlsZS90cmFuc3BpbGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OzttQkF5QndCLFNBQVM7Ozs7QUFGakMsS0FBSSxFQUFFLEVBQUUsRUFBRSxFQUFFLGFBQWEsQ0FBQTs7QUFFVixVQUFTLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRTtBQUM5QyxJQUFFLEdBQUcsR0FBRyxDQUFBO0FBQ1IsSUFBRSxHQUFHLEdBQUcsQ0FBQTtBQUNSLGVBQWEsR0FBRyxLQUFLLENBQUE7QUFDckIsUUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBOztBQUVoQixJQUFFLEdBQUcsRUFBRSxHQUFHLFNBQVMsQ0FBQTtBQUNuQixTQUFPLEdBQUcsQ0FBQTtFQUNWOztBQUVNLE9BQU0sQ0FBQyxHQUFHLFVBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFLO0FBQzNDLFFBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFBO0FBQ2xELE1BQUksRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsWUFBWSxLQUFLLENBQUEsQUFBQzs7QUFFakQsTUFBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFBO0FBQ25CLFNBQU8sR0FBRyxDQUFBO0VBQ1YsQ0FBQTs7U0FOWSxDQUFDLEdBQUQsQ0FBQztBQVFkLE9BQU0sWUFBWSxHQUFHLFVBQUEsQ0FBQztTQUFJLENBQUMsWUFBWSxLQUFLLEdBQUcsQ0FBQyxDQUFDLEdBQUcsZ0JBeEN6QixXQUFXLENBd0MyQixHQUFHLENBQUUsZUF4QzNDLFdBQVcsQ0F3QzRDLENBQUMsQ0FBQyxDQUFFO0VBQUEsQ0FBQTs7QUFFdEYsVUFBUyxjQUFjLENBQUMsSUFBSSxFQUFFLFlBQVksRUFB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LENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUcsQ0FBQTtFQUM3QyxDQUFBIiwiZmlsZSI6Im1ldGEvY29tcGlsZS9wcml2YXRlL3RyYW5zcGlsZS90cmFuc3BpbGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcnJheUV4cHJlc3Npb24sIEFzc2lnbm1lbnRFeHByZXNzaW9uLCBCbG9ja1N0YXRlbWVudCwgQnJlYWtTdGF0ZW1lbnQsXG5cdENhbGxFeHByZXNzaW9uLCBEZWJ1Z2dlclN0YXRlbWVudCwgSWRlbnRpZmllciwgTGFiZWxlZFN0YXRlbWVudCwgTGl0ZXJhbCxcblx0U3dpdGNoQ2FzZSwgVGhpc0V4cHJlc3Npb24sIFZhcmlhYmxlRGVjbGFyYXRvciwgUmV0dXJuU3RhdGVtZW50IH0gZnJvbSAnZXNhc3QvZGlzdC9hc3QnXG5pbXBvcnQgeyBpZENhY2hlZCwgbWVtYmVyLCB0b1N0YXRlbWVudCB9IGZyb20gJ2VzYXN0L2Rpc3QvdXRpbCdcbmltcG9ydCB7XG5cdGJpbmFyeUV4cHJlc3Npb25QbHVzLCBjYWxsRXhwcmVzc2lvblRodW5rLCBmdW5jdGlvbkV4cHJlc3Npb25QbGFpbiwgZnVuY3Rpb25FeHByZXNzaW9uVGh1bmssXG5cdHN3aXRjaFN0YXRlbWVudE9uVHJ1ZSxcblx0dW5hcnlFeHByZXNzaW9uTmVnYXRlLCB2YXJpYWJsZURlY2xhcmF0aW9uQ29uc3QsIHdoaWxlU3RhdGVtZW50SW5maW5pdGUsXG5cdHlpZWxkRXhwcmVzc2lvbkRlbGVnYXRlLCB5aWVsZEV4cHJlc3Npb25Ob0RlbGVnYXRlIH0gZnJvbSAnZXNhc3QvZGlzdC9zcGVjaWFsaXplJ1xuaW1wb3J0ICogYXMgRUV4cG9ydHMgZnJvbSAnLi4vLi4vRXhwcmVzc2lvbidcbmltcG9ydCB7IGZsYXRNYXAsIHB1c2gsIHJhbmdlLCB0YWlsIH0gZnJvbSAnLi4vVS9CYWcnXG5pbXBvcnQgeyBpZkVsc2UsIE5vbmUsIG9wSWYgfSBmcm9tICcuLi9VL09wJ1xuaW1wb3J0IHsgYXNzZXJ0LCBpbXBsZW1lbnRNYW55LCBpc1Bvc2l0aXZlIH0gZnJvbSAnLi4vVS91dGlsJ1xuaW1wb3J0IHsgZGVjbGFyZSwgZGVjbGFyZVNwZWNpYWwsIGlkRm9yRGVjbGFyZUNhY2hlZCwgdGhyb3dFcnJvciB9IGZyb20gJy4vZXNhc3QtdXRpbCdcbmltcG9ydCB7IHRyYW5zcGlsZU9ialJldHVybiwgdHJhbnNwaWxlT2JqU2ltcGxlIH0gZnJvbSAnLi90cmFuc3BpbGVPYmonXG5pbXBvcnQgdHJhbnNwaWxlTW9kdWxlIGZyb20gJy4vdHJhbnNwaWxlTW9kdWxlJ1xuaW1wb3J0IHtcblx0SWRFeHBvcnRzLCBJZEFyZ3VtZW50cywgSWRBcnJheVNsaWNlQ2FsbCwgSWRGdW5jdGlvbkFwcGx5Q2FsbCwgSWRNcyxcblx0TGl0RW1wdHlBcnJheSwgTGl0RW1wdHlTdHJpbmcsIExpdE51bGwsIEJyZWFrLCBSZXR1cm5SZXMsXG5cdGFjY2Vzc0xvY2FsLCBsYXp5V3JhcCwgbWFrZURlY2xhcmF0b3IsIG1ha2VEZXN0cnVjdHVyZURlY2xhcmF0b3JzLFxuXHRtYXliZVdyYXBJbkNoZWNrQ29udGFpbnMsXG5cdG9wTG9jYWxDaGVjaywgbXNBcnIsIG1zQm9vbCwgbXNNYXAsIG1zU2hvdyB9IGZyb20gJy4vdXRpbCdcblxubGV0IGN4LCB2ciwgaXNJbkdlbmVyYXRvclxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB0cmFuc3BpbGUoX2N4LCBlLCBfdnIpIHtcblx0Y3ggPSBfY3hcblx0dnIgPSBfdnJcblx0aXNJbkdlbmVyYXRvciA9IGZhbHNlXG5cdGNvbnN0IHJlcyA9IHQoZSlcblx0Ly8gUmVsZWFzZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uXG5cdGN4ID0gdnIgPSB1bmRlZmluZWRcblx0cmV0dXJuIHJlc1xufVxuXG5leHBvcnQgY29uc3QgdCA9IChleHByLCBhcmcsIGFyZzIsIGFyZzMpID0+IHtcblx0Y29uc3QgYXN0ID0gZXhwci50cmFuc3BpbGVTdWJ0cmVlKGFyZywgYXJnMiwgYXJnMylcblx0aWYgKGN4Lm9wdHMuc291cmNlTWFwKCkgJiYgIShhc3QgaW5zdGFuY2VvZiBBcnJheSkpXG5cdFx0Ly8gQXJyYXkgaXMgb25seSBhbGxvd2VkIGZvciBzdGF0ZW1lbnQgZ3JvdXBzIGluc2lkZSBvZiBCbG9ja3MsIHN1Y2ggYXMgRGVidWcuXG5cdFx0YXN0LmxvYyA9IGV4cHIubG9jXG5cdHJldHVybiBhc3Rcbn1cblxuY29uc3QgdG9TdGF0ZW1lbnRzID0gXyA9PiBfIGluc3RhbmNlb2YgQXJyYXkgPyBfLm1hcCh0b1N0YXRlbWVudCkgOiBbIHRvU3RhdGVtZW50KF8pIF1cblxuZnVuY3Rpb24gdHJhbnNwaWxlQmxvY2sobGVhZCwgb3BSZXNEZWNsYXJlLCBvcE91dCkge1xuXHRpZiAobGVhZCA9PT0gdW5kZWZpbmVkKVxuXHRcdGxlYWQgPSBbXVxuXHRpZiAob3BSZXNEZWNsYXJlID09PSB1bmRlZmluZWQpXG5cdFx0b3BSZXNEZWNsYXJlID0gb3BPdXQgPSBOb25lXG5cdGNvbnN0IGJvZHkgPSBmbGF0TWFwKHRoaXMubGluZXMsIGxpbmUgPT4gdG9TdGF0ZW1lbnRzKHQobGluZSkpKVxuXHRjb25zdCBpc1ZhbCA9IHRoaXMgaW5zdGFuY2VvZiBFRXhwb3J0cy5CbG9ja1ZhbFxuXHRjb25zdCBmaW4gPSBpZkVsc2Uob3BSZXNEZWNsYXJlLFxuXHRcdHJkID0+IHtcblx0XHRcdGFzc2VydChpc1ZhbClcblx0XHRcdGNvbnN0IHJldHVybmVkID0gbWF5YmVXcmFwSW5DaGVja0NvbnRhaW5zKGN4LCB0KHRoaXMucmV0dXJuZWQpLCByZC5vcFR5cGUsICdyZXMnKVxuXHRcdFx0cmV0dXJuIGlmRWxzZShvcE91dCxcblx0XHRcdFx0byA9PiBbIGRlY2xhcmUocmQsIHJldHVybmVkKSBdLmNvbmNhdChvLCBbIFJldHVyblJlcyBdKSxcblx0XHRcdFx0KCkgPT4gWyBSZXR1cm5TdGF0ZW1lbnQocmV0dXJuZWQpIF0pXG5cdFx0fSxcblx0XHQoKSA9PiBvcE91dC5jb25jYXQob3BJZihpc1ZhbCwgKCkgPT4gUmV0dXJuU3RhdGVtZW50KHQodGhpcy5yZXR1cm5lZCkpKSkpXG5cdHJldHVybiBCbG9ja1N0YXRlbWVudChsZWFkLmNvbmNhdChib2R5LCBmaW4pKVxufVxuXG5pbXBsZW1lbnRNYW55KEVFeHBvcnRzLCAndHJhbnNwaWxlU3VidHJlZScsIHtcblx0QXNzaWduKCkge1xuXHRcdHJldHVybiB2YXJpYWJsZURlY2xhcmF0aW9uQ29uc3QoW1xuXHRcdFx0bWFrZURlY2xhcmF0b3IoY3gsIHRoaXMubG9jLCB0aGlzLmFzc2lnbmVlLCB0aGlzLmssIHQodGhpcy52YWx1ZSkpIF0pXG5cdH0sXG5cdC8vIFRPRE86RVM2IEp1c3QgdXNlIG5hdGl2ZSBkZXN0cnVjdHVyaW5nIGFzc2lnblxuXHRBc3NpZ25EZXN0cnVjdHVyZSgpIHtcblx0XHRyZXR1cm4gdmFyaWFibGVEZWNsYXJhdGlvbkNvbnN0KFxuXHRcdFx0bWFrZURlc3RydWN0dXJlRGVjbGFyYXRvcnMoXG5cdFx0XHRcdGN4LFxuXHRcdFx0XHR0aGlzLmxvYyxcblx0XHRcdFx0dGhpcy5hc3NpZ25lZXMsXG5cdFx0XHRcdHRoaXMuaXNMYXp5LFxuXHRcdFx0XHR0KHRoaXMudmFsdWUpLFxuXHRcdFx0XHR0aGlzLmssXG5cdFx0XHRcdGZhbHNlKSlcblx0fSxcblx0QmxvY2tEbzogdHJhbnNwaWxlQmxvY2ssXG5cdEJsb2NrVmFsOiB0cmFuc3BpbGVCbG9jayxcblx0QmxvY2tXcmFwKCkgeyByZXR1cm4gYmxvY2tXcmFwKHRoaXMsIHQodGhpcy5ibG9jaykpIH0sXG5cdENhbGwoKSB7XG5cdFx0Y29uc3QgYW55U3BsYXQgPSB0aGlzLmFyZ3Muc29tZShhcmcgPT4gYXJnIGluc3RhbmNlb2YgRUV4cG9ydHMuU3BsYXQpXG5cdFx0aWYgKGFueVNwbGF0KSB7XG5cdFx0XHRjb25zdCBhcmdzID0gdGhpcy5hcmdzLm1hcChhcmcgPT5cblx0XHRcdFx0YXJnIGluc3RhbmNlb2YgRUV4cG9ydHMuU3BsYXQgP1xuXHRcdFx0XHRcdG1zQXJyKFsgdChhcmcuc3BsYXR0ZWQpIF0pIDpcblx0XHRcdFx0XHR0KGFyZykpXG5cdFx0XHRyZXR1cm4gQ2FsbEV4cHJlc3Npb24oSWRGdW5jdGlvbkFwcGx5Q2FsbCwgW1xuXHRcdFx0XHR0KHRoaXMuY2FsbGVkKSxcblx0XHRcdFx0TGl0TnVsbCxcblx0XHRcdFx0Q2FsbEV4cHJlc3Npb24obWVtYmVyKExpdEVtcHR5QXJyYXksICdjb25jYXQnKSwgYXJncyldKVxuXHRcdH1cblx0XHRlbHNlIHJldHVybiBDYWxsRXhwcmVzc2lvbih0KHRoaXMuY2FsbGVkKSwgdGhpcy5hcmdzLm1hcCh0KSlcblx0fSxcblx0Q2FzZURvKCkge1xuXHRcdHJldHVybiBpZkVsc2UodGhpcy5vcENhc2VkLFxuXHRcdFx0Y2FzZWQgPT4gQmxvY2tTdGF0ZW1lbnQoWyB0KGNhc2VkKSwgY2FzZUJvZHkodGhpcy5wYXJ0cywgdGhpcy5vcEVsc2UpIF0pLFxuXHRcdFx0KCkgPT4gY2FzZUJvZHkodGhpcy5wYXJ0cywgdGhpcy5vcEVsc2UpKVxuXHR9LFxuXHRDYXNlVmFsKCkge1xuXHRcdGNvbnN0IGJvZHkgPSBjYXNlQm9keSh0aGlzLnBhcnRzLCB0aGlzLm9wRWxzZSlcblx0XHRjb25zdCBibG9jayA9IGlmRWxzZSh0aGlzLm9wQ2FzZWQsIGNhc2VkID0+IFsgdChjYXNlZCksIGJvZHkgXSwgKCkgPT4gWyBib2R5IF0pXG5cdFx0cmV0dXJuIGJsb2NrV3JhcCh0aGlzLCBCbG9ja1N0YXRlbWVudChibG9jaykpXG5cdH0sXG5cdENhc2VEb1BhcnQoKSB7IHJldHVybiBjYXNlUGFydCh0aGlzLnRlc3QsIHRoaXMucmVzdWx0LCB0cnVlKSB9LFxuXHRDYXNlVmFsUGFydCgpIHsgcmV0dXJuIGNhc2VQYXJ0KHRoaXMudGVzdCwgdGhpcy5yZXN1bHQsIGZhbHNlKSB9LFxuXHQvLyBUT0RPOiBpbmNsdWRlSW5vdXRDaGVja3MgaXMgbWlzbmFtZWRcblx0RGVidWcoKSB7XG5cdFx0cmV0dXJuIGN4Lm9wdHMuaW5jbHVkZUlub3V0Q2hlY2tzKCkgP1xuXHRcdFx0ZmxhdE1hcCh0aGlzLmxpbmVzLCBsaW5lID0+IHRvU3RhdGVtZW50cyh0KGxpbmUpKSkgOlxuXHRcdFx0WyBdXG5cdH0sXG5cdE9ialJldHVybigpIHsgcmV0dXJuIHRyYW5zcGlsZU9ialJldHVybih0aGlzLCBjeCkgfSxcblx0T2JqU2ltcGxlKCkgeyByZXR1cm4gdHJhbnNwaWxlT2JqU2ltcGxlKHRoaXMsIGN4KSB9LFxuXHRFbmRMb29wKCkgeyByZXR1cm4gQnJlYWtTdGF0ZW1lbnQobG9vcElkKHZyLmVuZExvb3BUb0xvb3AuZ2V0KHRoaXMpKSkgfSxcblx0RnVuKCkge1xuXHRcdGNvbnN0IG9sZEluR2VuZXJhdG9yID0gaXNJbkdlbmVyYXRvclxuXHRcdGlzSW5HZW5lcmF0b3IgPSB0aGlzLmsgPT09ICd+fCdcblxuXHRcdC8vIFRPRE86RVM2IHVzZSBgLi4uYFxuXHRcdGNvbnN0IG5BcmdzID0gTGl0ZXJhbCh0aGlzLmFyZ3MubGVuZ3RoKVxuXHRcdGNvbnN0IG9wRGVjbGFyZVJlc3QgPSB0aGlzLm9wUmVzdEFyZy5tYXAocmVzdCA9PlxuXHRcdFx0ZGVjbGFyZShyZXN0LCBDYWxsRXhwcmVzc2lvbihJZEFycmF5U2xpY2VDYWxsLCBbSWRBcmd1bWVudHMsIG5BcmdzXSkpKVxuXHRcdGNvbnN0IGFyZ0NoZWNrcyA9IGZsYXRNYXAodGhpcy5hcmdzLCBhcmcgPT4gb3BMb2NhbENoZWNrKGN4LCBhcmcsIGFyZy5pc0xhenkpKVxuXHRcdGNvbnN0IF9pbiA9IGZsYXRNYXAodGhpcy5vcEluLCBpID0+IHRvU3RhdGVtZW50cyh0KGkpKSlcblx0XHRjb25zdCBsZWFkID0gb3BEZWNsYXJlUmVzdC5jb25jYXQoYXJnQ2hlY2tzLCBfaW4pXG5cblx0XHRjb25zdCBfb3V0ID0gZmxhdE1hcCh0aGlzLm9wT3V0LCBvID0+IHRvU3RhdGVtZW50cyh0KG8pKSlcblx0XHRjb25zdCBib2R5ID0gdCh0aGlzLmJsb2NrLCBsZWFkLCB0aGlzLm9wUmVzRGVjbGFyZSwgX291dClcblx0XHRjb25zdCBhcmdzID0gdGhpcy5hcmdzLm1hcCh0KVxuXHRcdGNvbnN0IHJlcyA9IGZ1bmN0aW9uRXhwcmVzc2lvblBsYWluKGFyZ3MsIGJvZHksIHRoaXMuayA9PT0gJ358JylcblxuXHRcdGlzSW5HZW5lcmF0b3IgPSBvbGRJbkdlbmVyYXRvclxuXHRcdHJldHVybiByZXNcblx0fSxcblx0TGF6eSgpIHsgcmV0dXJuIGxhenlXcmFwKHQodGhpcy52YWx1ZSkpIH0sXG5cdExpc3RSZXR1cm4oKSB7XG5cdFx0cmV0dXJuIEFycmF5RXhwcmVzc2lvbihyYW5nZSgwLCB0aGlzLmxlbmd0aCkubWFwKGkgPT4gaWRDYWNoZWQoYF8ke2l9YCkpKVxuXHR9LFxuXHRMaXN0U2ltcGxlKCkgeyByZXR1cm4gQXJyYXlFeHByZXNzaW9uKHRoaXMucGFydHMubWFwKHQpKSB9LFxuXHRMaXN0RW50cnkoKSB7IHJldHVybiBkZWNsYXJlU3BlY2lhbChgXyR7dGhpcy5pbmRleH1gLCB0KHRoaXMudmFsdWUpKSB9LFxuXHROdW1iZXJMaXRlcmFsKCkge1xuXHRcdC8vIE5lZ2F0aXZlIG51bWJlcnMgYXJlIG5vdCBwYXJ0IG9mIEVTIHNwZWMuXG5cdFx0Ly8gaHR0cDovL3d3dy5lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzUuMS8jc2VjLTcuOC4zXG5cdFx0Y29uc3QgbGl0ID0gTGl0ZXJhbChNYXRoLmFicyh0aGlzLnZhbHVlKSlcblx0XHRyZXR1cm4gaXNQb3NpdGl2ZSh0aGlzLnZhbHVlKSA/IGxpdCA6IHVuYXJ5RXhwcmVzc2lvbk5lZ2F0ZShsaXQpXG5cdH0sXG5cdEdsb2JhbEFjY2VzcygpIHsgcmV0dXJuIElkZW50aWZpZXIodGhpcy5uYW1lKSB9LFxuXHRMb2NhbEFjY2VzcygpIHsgcmV0dXJuIGFjY2Vzc0xvY2FsKHRoaXMsIHZyKSB9LFxuXHRMb2NhbERlY2xhcmUoKSB7IHJldHVybiBpZEZvckRlY2xhcmVDYWNoZWQodGhpcykgfSxcblx0Ly8gVE9ETzogRG9uJ3QgYWx3YXlzIGxhYmVsIVxuXHRMb29wKCkge1xuXHRcdHJldHVybiBMYWJlbGVkU3RhdGVtZW50KGxvb3BJZCh0aGlzKSwgd2hpbGVTdGF0ZW1lbnRJbmZpbml0ZSh0KHRoaXMuYmxvY2spKSlcblx0fSxcblx0TWFwUmV0dXJuKCkge1xuXHRcdHJldHVybiBtc01hcChmbGF0TWFwKHJhbmdlKDAsIHRoaXMubGVuZ3RoKSwgaSA9PlxuXHRcdFx0WyBpZENhY2hlZCgnX2snICsgaS50b1N0cmluZygpKSwgaWRDYWNoZWQoJ192JyArIGkudG9TdHJpbmcoKSkgXSkpXG5cdH0sXG5cdE1hcEVudHJ5KCkge1xuXHRcdHJldHVybiB2YXJpYWJsZURlY2xhcmF0aW9uQ29uc3QoW1xuXHRcdFx0VmFyaWFibGVEZWNsYXJhdG9yKGlkQ2FjaGVkKGBfayR7dGhpcy5pbmRleH1gKSwgdCh0aGlzLmtleSkpLFxuXHRcdFx0VmFyaWFibGVEZWNsYXJhdG9yKGlkQ2FjaGVkKGBfdiR7dGhpcy5pbmRleH1gKSwgdCh0aGlzLnZhbCkpXG5cdFx0XSlcblx0fSxcblx0TWVtYmVyKCkge1xuXHRcdHJldHVybiBtZW1iZXIodCh0aGlzLm9iamVjdCksIHRoaXMubmFtZSlcblx0fSxcblx0TW9kdWxlKCkgeyByZXR1cm4gdHJhbnNwaWxlTW9kdWxlKHRoaXMsIGN4KSB9LFxuXHQvLyBUT0RPOkVTNiBVc2UgYGV4cG9ydCBkZWZhdWx0YFxuXHRNb2R1bGVEZWZhdWx0RXhwb3J0KCkge1xuXHRcdGNvbnN0IG0gPSBtZW1iZXIoSWRFeHBvcnRzLCAnZGVmYXVsdCcpXG5cdFx0cmV0dXJuIEFzc2lnbm1lbnRFeHByZXNzaW9uKCc9JywgbSwgdCh0aGlzLnZhbHVlKSlcblx0fSxcblx0UXVvdGUoKSB7XG5cdFx0Ly8gVE9ETzpFUzYgdXNlIHRlbXBsYXRlIHN0cmluZ3Ncblx0XHRjb25zdCBwYXJ0MCA9IHRoaXMucGFydHNbMF1cblx0XHRjb25zdCBbIGZpcnN0LCByZXN0UGFydHMgXSA9XG5cdFx0XHR0eXBlb2YgcGFydDAgPT09ICdzdHJpbmcnID9cblx0XHRcdFx0WyBMaXRlcmFsKHBhcnQwKSwgdGFpbCh0aGlzLnBhcnRzKSBdIDpcblx0XHRcdFx0WyBMaXRFbXB0eVN0cmluZywgdGhpcy5wYXJ0cyBdXG5cdFx0cmV0dXJuIHJlc3RQYXJ0cy5yZWR1Y2UoXG5cdFx0XHQoZXgsIF8pID0+XG5cdFx0XHRcdGJpbmFyeUV4cHJlc3Npb25QbHVzKGV4LCB0eXBlb2YgXyA9PT0gJ3N0cmluZycgPyBMaXRlcmFsKF8pIDogbXNTaG93KFsgdChfKSBdKSksXG5cdFx0XHRmaXJzdClcblx0fSxcblx0U3BlY2lhbCgpIHtcblx0XHQvLyBNYWtlIG5ldyBvYmplY3RzIGJlY2F1c2Ugd2Ugd2lsbCBhc3NpZ24gYGxvY2AgdG8gdGhlbS5cblx0XHRzd2l0Y2ggKHRoaXMuaykge1xuXHRcdFx0Y2FzZSAnY29udGFpbnMnOiByZXR1cm4gbWVtYmVyKElkTXMsICdjb250YWlucycpXG5cdFx0XHRjYXNlICdkZWJ1Z2dlcic6IHJldHVybiBEZWJ1Z2dlclN0YXRlbWVudCgpXG5cdFx0XHRjYXNlICdzdWInOiByZXR1cm4gbWVtYmVyKElkTXMsICdzdWInKVxuXHRcdFx0Y2FzZSAndGhpcyc6IHJldHVybiBcdFRoaXNFeHByZXNzaW9uKClcblx0XHRcdGNhc2UgJ3RoaXMtbW9kdWxlLWRpcmVjdG9yeSc6IHJldHVybiBJZGVudGlmaWVyKCdfX2Rpcm5hbWUnKVxuXHRcdFx0ZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKHRoaXMuaylcblx0XHR9XG5cdH0sXG5cdFNwbGF0KCkgeyBjeC5mYWlsKHRoaXMubG9jLCAnU3BsYXQgbXVzdCBhcHBlYXIgYXMgYXJndW1lbnQgdG8gYSBjYWxsLicpIH0sXG5cdFlpZWxkKCkgeyByZXR1cm4geWllbGRFeHByZXNzaW9uTm9EZWxlZ2F0ZSh0KHRoaXMueWllbGRlZCkpIH0sXG5cdFlpZWxkVG8oKSB7IHJldHVybiB5aWVsZEV4cHJlc3Npb25EZWxlZ2F0ZSh0KHRoaXMueWllbGRlZFRvKSkgfVxufSlcblxuY29uc3QgYmxvY2tXcmFwID0gKF8sIGJsb2NrKSA9PiB7XG5cdGNvbnN0IGcgPSBpc0luR2VuZXJhdG9yXG5cdGNvbnN0IGludm9rZSA9IGNhbGxFeHByZXNzaW9uVGh1bmsoZnVuY3Rpb25FeHByZXNzaW9uVGh1bmsoYmxvY2ssIGcpKVxuXHRyZXR1cm4gZyA/IHlpZWxkRXhwcmVzc2lvbkRlbGVnYXRlKGludm9rZSkgOiBpbnZva2Vcbn1cblxuY29uc3QgY2FzZUZhaWwgPSBTd2l0Y2hDYXNlKG51bGwsIFsgdGhyb3dFcnJvcignTm8gYnJhbmNoIG9mIGBjYXNlYCBtYXRjaGVzLicpIF0pXG5mdW5jdGlvbiBjYXNlQm9keShwYXJ0cywgb3BFbHNlKSB7XG5cdGNvbnN0IGVsemUgPSBpZkVsc2Uob3BFbHNlLFxuXHRcdF8gPT4gU3dpdGNoQ2FzZShudWxsLCBbIHQoXykgXSksXG5cdFx0KCkgPT4gY2FzZUZhaWwpXG5cdGNvbnN0IGNhc2VzID0gcHVzaChwYXJ0cy5tYXAocGFydCA9PiB0KHBhcnQpKSwgZWx6ZSlcblx0cmV0dXJuIHN3aXRjaFN0YXRlbWVudE9uVHJ1ZShjYXNlcylcbn1cblxuZnVuY3Rpb24gY2FzZVBhcnQodGVzdCwgcmVzdWx0LCBuZWVkQnJlYWspIHtcblx0Y29uc3QgY2hlY2tlZFRlc3QgPSBjeC5vcHRzLmluY2x1ZGVDYXNlQ2hlY2tzKCkgPyBtc0Jvb2woWyB0KHRlc3QpIF0pIDogdCh0ZXN0KVxuXHRjb25zdCBsaW5lcyA9IG5lZWRCcmVhayA/IFsgdChyZXN1bHQpLCBCcmVhayBdIDogWyB0KHJlc3VsdCkgXVxuXHRyZXR1cm4gU3dpdGNoQ2FzZShjaGVja2VkVGVzdCwgbGluZXMpXG59XG5cbi8vIFRPRE86IE1PVkVcbmNvbnN0IGxvb3BJZCA9IGxvb3AgPT4ge1xuXHRyZXR1cm4gaWRDYWNoZWQoYGxvb3Ake2xvb3AubG9jLnN0YXJ0LmxpbmV9YClcbn1cbiJdLCJzb3VyY2VSb290IjoiL3NyYyJ9