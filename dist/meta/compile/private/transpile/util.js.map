{"version":3,"sources":["meta/compile/private/transpile/util.js"],"names":[],"mappings":"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","file":"meta/compile/private/transpile/util.js","sourcesContent":["import { ArrayExpression, AssignmentExpression, BreakStatement, CallExpression, ExpressionStatement,\n\tIdentifier, Literal, ReturnStatement, VariableDeclarator } from 'esast/dist/ast'\nimport Loc from 'esast/dist/Loc'\nimport { member, thunk } from 'esast/dist/util'\nimport Expression, { LocalAccess, LocalDeclare } from '../../Expression'\nimport { KAssign } from '../Lang'\nimport { flatMap, isEmpty, unshift } from '../U/Bag'\nimport { ifElse, None } from '../U/Op'\nimport type from '../U/type'\nimport { assert } from '../U/util'\nimport { idForDeclareCached, idForDeclareNew } from './esast-util'\nimport Tx from './Tx'\n\nexport const t = (tx, arg, arg2, arg3) => expr => {\n\tconst ast = expr.transpileSubtree(expr, tx, arg, arg2, arg3)\n\tif (tx.opts().sourceMap()) {\n\t\tconst setLoc = _ => { _.loc = expr.loc }\n\t\tif (ast instanceof Array)\n\t\t\t// This is only allowed inside of Blocks, which use `toStatements`.\n\t\t\tast.forEach(setLoc)\n\t\telse\n\t\t\tsetLoc(ast)\n\t}\n\treturn ast\n}\n\nexport const\n\tLitEmptyArray = ArrayExpression([]),\n\tLitEmptyString = Literal(''),\n\tLitNull = Literal(null),\n\tLitStrDisplayName = Literal('displayName'),\n\tBreak = BreakStatement(),\n\tReturnRes = ReturnStatement(Identifier('res')),\n\tIdDefine = Identifier('define'),\n\tIdDisplayName = Identifier('displayName'),\n\tIdExports = Identifier('exports'),\n\tIdArguments = Identifier('arguments'),\n\tIdArraySliceCall = member(member(LitEmptyArray, 'slice'), 'call'),\n\tIdFunctionApplyCall = member(member(Identifier('Function'), 'apply'), 'call'),\n\tIdModule = Identifier('module'),\n\tIdMs = Identifier('_ms')\n\nconst ms = name => {\n\tconst m = member(IdMs, name)\n\treturn args => CallExpression(m, args)\n}\nexport const\n\tmsGetDefaultExport = ms('getDefaultExport'),\n\tmsGet = ms('get'),\n\tmsGetModule = ms('getModule'),\n\tmsLazyGetModule = ms('lazyGetModule'),\n\tmsArr = ms('arr'),\n\tmsBool = ms('bool'),\n\tmsLset = ms('lset'),\n\tmsSet = ms('set'),\n\tmsMap = ms('map'),\n\tmsShow = ms('show'),\n\tmsCheckContains = ms('checkContains'),\n\tmsUnlazy = ms('unlazy'),\n\tmsLazy = ms('lazy'),\n\tmsLazyGet = ms('lazyProp')\n\nexport const makeDestructureDeclarators = (tx, loc, assignees, isLazy, value, k, isModule) => {\n\ttype(tx, Tx, loc, Loc, assignees, [LocalDeclare],\n\t\tisLazy, Boolean, value, Object, k, KAssign, isModule, Boolean)\n\tconst destructuredName = `_$${loc.start.line}`\n\tconst idDestructured = Identifier(destructuredName)\n\tconst declarators = assignees.map(assignee => {\n\t\t// TODO: Don't compile it if it's never accessed\n\t\tconst get = getMember(tx, idDestructured, assignee.name, isLazy, isModule)\n\t\treturn makeDeclarator(tx, assignee.loc, assignee, k, get, isLazy)\n\t})\n\t// Getting lazy module is done by ms.lazyGetModule.\n\tconst val = (isLazy && !isModule) ? lazyWrap(value) : value\n\treturn unshift(VariableDeclarator(idDestructured, val), declarators)\n}\n\nconst getMember = (tx, astObject, gotName, isLazy, isModule) => {\n\ttype(astObject, Object, gotName, String, isLazy, Boolean, isModule, Boolean)\n\tif (isLazy)\n\t\treturn msLazyGet([ astObject, Literal(gotName) ])\n\telse if (isModule && tx.opts().includeUseChecks())\n\t\treturn msGet([ astObject, Literal(gotName) ])\n\telse\n\t\treturn member(astObject, gotName)\n}\n\nexport const makeDeclarator = (tx, loc, assignee, k, value, valueIsAlreadyLazy) => {\n\ttype(tx, Tx, loc, Loc, assignee, Expression, k, KAssign, value, Object)\n\t// TODO: assert(isEmpty(assignee.opType))\n\t// or TODO: Allow type check on lazy value?\n\tvalue = assignee.isLazy ? value :\n\t\tmaybeWrapInCheckContains(value, tx, assignee.opType, assignee.name)\n\tswitch (k) {\n\t\tcase '=': case '. ': case '<~': case '<~~': {\n\t\t\tconst val = assignee.isLazy && !valueIsAlreadyLazy ? lazyWrap(value) : value\n\t\t\tassert(assignee.isLazy || !valueIsAlreadyLazy)\n\t\t\treturn VariableDeclarator(idForDeclareCached(assignee), val)\n\t\t}\n\t\tcase 'export': {\n\t\t\t// TODO:ES6\n\t\t\tassert(!assignee.isLazy)\n\t\t\treturn VariableDeclarator(\n\t\t\t\tidForDeclareCached(assignee),\n\t\t\t\tAssignmentExpression('=', member(IdExports, assignee.name), value))\n\t\t}\n\t\tdefault: throw new Error(k)\n\t}\n}\n\nexport const accessLocal = (tx, localAccess) => {\n\ttype(tx, Tx, localAccess, LocalAccess)\n\treturn accessLocalDeclare(tx.vr.accessToLocal.get(localAccess))\n}\nexport const accessLocalDeclare = localDeclare => {\n\ttype(localDeclare, LocalDeclare)\n\treturn localDeclare.isLazy ?\n\t\tmsUnlazy([ idForDeclareCached(localDeclare) ]) :\n\t\tidForDeclareNew(localDeclare)\n}\n\nexport const maybeWrapInCheckContains = (ast, tx, opType, name) =>\n\ttx.opts().includeTypeChecks() ?\n\t\tifElse(opType,\n\t\t\ttyp => msCheckContains([ t(tx)(typ), ast, Literal(name) ]),\n\t\t\t() => ast) :\n\t\tast\n\nexport const opLocalCheck = (tx, local, isLazy) => {\n\ttype(tx, Tx, local, LocalDeclare, isLazy, Boolean)\n\t// TODO: Way to typecheck lazies\n\tif (!tx.opts().includeTypeChecks() || isLazy)\n\t\treturn None\n\treturn local.opType.map(typ =>\n\t\tExpressionStatement(msCheckContains([\n\t\t\tt(tx)(typ),\n\t\t\taccessLocalDeclare(local),\n\t\t\tLiteral(local.name)])))\n}\n\nexport const lazyWrap = value => msLazy([ thunk(value) ])\n"],"sourceRoot":"/src"}