if (typeof define !== 'function') var define = require('amdefine')(module);define(['exports', 'module', 'esast/dist/ast', 'esast/dist/util', 'esast/dist/specialize', '../manglePath', '../U/Bag', '../U/op', './esast-util', './transpile', './util'], function (exports, module, _esastDistAst, _esastDistUtil, _esastDistSpecialize, _manglePath, _UBag, _UOp, _esastUtil, _transpile, _util) {
	'use strict';

	function _interopRequire(obj) { return obj && obj.__esModule ? obj['default'] : obj; }

	var _manglePath2 = _interopRequire(_manglePath);

	/*
 'use strict';
 if (typeof define !== 'function')
 	var define = require('amdefine')(module);
 define(['exports', 'a', 'b', 'c'], function(exports) {
 	// Fake exports -- just a getter.
 	exports._get = _ms.lazy(function() {
 		const exports = {} // Real exports
 		... imports ...
 		{
 			... exports ...
 		}
 		return exports
 	})
 })
 */

	module.exports = function (_, cx) {
		const allUses = _.doUses.concat(_.uses, _.debugUses);
		const amdNames = _esastDistAst.ArrayExpression(AmdFirstUses.concat(allUses.map(function (use) {
			return _esastDistAst.Literal(_manglePath2(use.path));
		})));
		const useIdentifiers = allUses.map(useIdentifier);
		const amdArgs = AmdFirstArgs.concat(useIdentifiers);
		const useDos = _.doUses.map(function (use, i) {
			const d = _esastDistAst.ExpressionStatement(_util.msGetModule(useIdentifiers[i]));
			d.loc = use.loc;
			return d;
		});
		const allUseDeclarators = _UBag.flatMap(_.uses.concat(_.debugUses), function (use, i) {
			return useDeclarators(cx, use, useIdentifiers[i + _.doUses.length]);
		});
		const opUseDeclare = _UOp.opIf(!_UBag.isEmpty(allUseDeclarators), function () {
			return _esastDistAst.VariableDeclaration('const', allUseDeclarators);
		});

		// TODO: Some way of determining when it's OK for a module to not be lazy.
		const isLazy = cx.opts.lazyModule();

		const lines = _UBag.flatMap(_.lines, function (line) {
			return _util.toStatements(_transpile.tm(line));
		});

		const opDefaultExport = _UOp.opMap(_.opDefaultExport, function (_) {
			return _esastDistAst.AssignmentExpression('=', ExportsDefault, _transpile.t0(_));
		});

		const moduleBody = _esastDistAst.BlockStatement(_UBag.cat(useDos, opUseDeclare, lines, opDefaultExport, [ReturnExports]));

		const body = isLazy ? _esastDistAst.BlockStatement([lazyBody(moduleBody)]) : moduleBody;

		const doDefine = _esastDistAst.ExpressionStatement(_esastDistAst.CallExpression(_util.IdDefine, [amdNames, _esastDistAst.FunctionExpression(null, amdArgs, body)]));

		const opUseStrict = _UOp.opIf(cx.opts.includeUseStrict(), function () {
			return UseStrict;
		});
		const opAmdefine = _UOp.opIf(cx.opts.amdefine(), function () {
			return AmdefineHeader;
		});

		return _esastDistAst.Program(_UBag.cat(opUseStrict, opAmdefine, doDefine));
	};

	const useDeclarators = function (cx, _, moduleIdentifier) {
		// TODO: Could be neater about this
		const isLazy = (_UBag.isEmpty(_.used) ? _.opUseDefault : _.used[0]).isLazy;
		const value = (isLazy ? _util.msLazyGetModule : _util.msGetModule)(moduleIdentifier);

		const usedDefault = _UOp.opMap(_.opUseDefault, function (def) {
			const defexp = _util.msGetDefaultExport(moduleIdentifier);
			const val = isLazy ? _util.lazyWrap(defexp) : defexp;
			const vd = _esastDistAst.VariableDeclarator(_esastUtil.idForDeclareCached(def), val);
			vd.loc = def.loc;
			return vd;
		});

		const usedDestruct = _UBag.isEmpty(_.used) ? null : _util.makeDestructureDeclarators(cx, _.loc, _.used, isLazy, value, true, false);

		return _UBag.cat(usedDefault, usedDestruct);
	};

	const useIdentifier = function (use, i) {
		return _esastDistUtil.idCached('' + _UBag.last(use.path.split('/')) + '_' + i);
	},
	      lazyBody = function (body) {
		return _esastDistAst.ExpressionStatement(_esastDistSpecialize.assignmentExpressionPlain(_esastDistUtil.member(_util.IdExports, '_get'), _util.msLazy(_esastDistAst.FunctionExpression(null, [], body))));
	},
	     

	// if (typeof define !== 'function') var define = require('amdefine')(module)
	AmdefineHeader = _esastDistAst.IfStatement(_esastDistAst.BinaryExpression('!==', _esastDistAst.UnaryExpression('typeof', _util.IdDefine), _esastDistAst.Literal('function')), _esastDistAst.VariableDeclaration('var', [_esastDistAst.VariableDeclarator(_util.IdDefine, _esastDistAst.CallExpression(_esastDistAst.CallExpression(_esastDistAst.Identifier('require'), [_esastDistAst.Literal('amdefine')]), [_util.IdModule]))])),
	      UseStrict = _esastDistAst.ExpressionStatement(_esastDistAst.Literal('use strict')),
	      ReturnExports = _esastDistAst.ReturnStatement(_util.IdExports),
	      ExportsDefault = _esastDistUtil.member(_util.IdExports, 'default'),
	      AmdFirstUses = [_esastDistAst.Literal('exports')],
	      AmdFirstArgs = [_util.IdExports];
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1ldGEvY29tcGlsZS9wcml2YXRlL3RyYW5zcGlsZS90cmFuc3BpbGVNb2R1bGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2tCQThCZSxVQUFDLENBQUMsRUFBRSxFQUFFLEVBQUs7QUFDekIsUUFBTSxPQUFPLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUE7QUFDcEQsUUFBTSxRQUFRLEdBQUcsY0FoQ1QsZUFBZSxDQWdDVSxZQUFZLENBQUMsTUFBTSxDQUNuRCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUEsR0FBRztVQUFJLGNBaEM4QyxPQUFPLENBZ0M3QyxhQUFXLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztHQUFBLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDcEQsUUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUNqRCxRQUFNLE9BQU8sR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBQ25ELFFBQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFVBQUMsR0FBRyxFQUFFLENBQUMsRUFBSztBQUN2QyxTQUFNLENBQUMsR0FBRyxjQXBDQyxtQkFBbUIsQ0FvQ0EsTUF6QmpCLFdBQVcsQ0F5QmtCLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDN0QsSUFBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFBO0FBQ2YsVUFBTyxDQUFDLENBQUE7R0FDUixDQUFDLENBQUE7QUFDRixRQUFNLGlCQUFpQixHQUFHLE1BbENiLE9BQU8sQ0FrQ2MsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxFQUFFLFVBQUMsR0FBRyxFQUFFLENBQUM7VUFD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RUFDakYsY0FoR2lDLG1CQUFtQixDQWdHaEMsS0FBSyxFQUFFLENBQzFCLGNBakdxRCxrQkFBa0IsT0FTakUsUUFBUSxFQXdGZSxjQW5Ha0QsY0FBYyxDQW9HNUYsY0FwRzhFLGNBQWMsQ0FvRzdFLGNBbkdsQixVQUFVLENBbUdtQixTQUFTLENBQUMsRUFBRSxDQUFFLGNBbkd1QixPQUFPLENBbUd0QixVQUFVLENBQUMsQ0FBRSxDQUFDLEVBQzlELE9BMUYwQixRQUFRLENBMEZ0QixDQUFDLENBQUMsQ0FBRSxDQUFDLENBQUM7T0FFckIsU0FBUyxHQUFHLGNBdEdBLG1CQUFtQixDQXNHQyxjQXRHa0MsT0FBTyxDQXNHakMsWUFBWSxDQUFDLENBQUM7T0FFdEQsYUFBYSxHQUFHLGNBdkdoQixlQUFlLE9BU0csU0FBUyxDQThGZTtPQUUxQyxjQUFjLEdBQUcsZUF2R0MsTUFBTSxPQU9OLFNBQVMsRUFnR1EsU0FBUyxDQUFDO09BRTdDLFlBQVksR0FBRyxDQUFFLGNBNUdpRCxPQUFPLENBNEdoRCxTQUFTLENBQUMsQ0FBRTtPQUNyQyxZQUFZLEdBQUcsT0FuR0csU0FBUyxDQW1HQyxDQUFBIiwiZmlsZSI6Im1ldGEvY29tcGlsZS9wcml2YXRlL3RyYW5zcGlsZS90cmFuc3BpbGVNb2R1bGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcnJheUV4cHJlc3Npb24sIEFzc2lnbm1lbnRFeHByZXNzaW9uLCBCaW5hcnlFeHByZXNzaW9uLCBCbG9ja1N0YXRlbWVudCwgQ2FsbEV4cHJlc3Npb24sXG5cdElkZW50aWZpZXIsIEV4cHJlc3Npb25TdGF0ZW1lbnQsIEZ1bmN0aW9uRXhwcmVzc2lvbiwgSWZTdGF0ZW1lbnQsIExpdGVyYWwsIFByb2dyYW0sXG5cdFJldHVyblN0YXRlbWVudCwgVW5hcnlFeHByZXNzaW9uLCBWYXJpYWJsZURlY2xhcmF0aW9uLCBWYXJpYWJsZURlY2xhcmF0b3Jcblx0fSBmcm9tICdlc2FzdC9kaXN0L2FzdCdcbmltcG9ydCB7IGlkQ2FjaGVkLCBtZW1iZXIgfSBmcm9tICdlc2FzdC9kaXN0L3V0aWwnXG5pbXBvcnQgeyBhc3NpZ25tZW50RXhwcmVzc2lvblBsYWluIH0gZnJvbSAnZXNhc3QvZGlzdC9zcGVjaWFsaXplJ1xuaW1wb3J0IG1hbmdsZVBhdGggZnJvbSAnLi4vbWFuZ2xlUGF0aCdcbmltcG9ydCB7IGNhdCwgZmxhdE1hcCwgaXNFbXB0eSwgbGFzdCB9IGZyb20gJy4uL1UvQmFnJ1xuaW1wb3J0IHsgb3BJZiwgb3BNYXAgfSBmcm9tICcuLi9VL29wJ1xuaW1wb3J0IHsgaWRGb3JEZWNsYXJlQ2FjaGVkIH0gZnJvbSAnLi9lc2FzdC11dGlsJ1xuaW1wb3J0IHsgdDAsIHRtIH0gZnJvbSAnLi90cmFuc3BpbGUnXG5pbXBvcnQgeyBJZERlZmluZSwgSWRFeHBvcnRzLCBJZE1vZHVsZSwgbGF6eVdyYXAsIG1ha2VEZXN0cnVjdHVyZURlY2xhcmF0b3JzLFxuXHR0b1N0YXRlbWVudHMsIG1zR2V0TW9kdWxlLCBtc0xhenlHZXRNb2R1bGUsIG1zR2V0RGVmYXVsdEV4cG9ydCwgbXNMYXp5IH0gZnJvbSAnLi91dGlsJ1xuXG4vKlxuJ3VzZSBzdHJpY3QnO1xuaWYgKHR5cGVvZiBkZWZpbmUgIT09ICdmdW5jdGlvbicpXG5cdHZhciBkZWZpbmUgPSByZXF1aXJlKCdhbWRlZmluZScpKG1vZHVsZSk7XG5kZWZpbmUoWydleHBvcnRzJywgJ2EnLCAnYicsICdjJ10sIGZ1bmN0aW9uKGV4cG9ydHMpIHtcblx0Ly8gRmFrZSBleHBvcnRzIC0tIGp1c3QgYSBnZXR0ZXIuXG5cdGV4cG9ydHMuX2dldCA9IF9tcy5sYXp5KGZ1bmN0aW9uKCkge1xuXHRcdGNvbnN0IGV4cG9ydHMgPSB7fSAvLyBSZWFsIGV4cG9ydHNcblx0XHQuLi4gaW1wb3J0cyAuLi5cblx0XHR7XG5cdFx0XHQuLi4gZXhwb3J0cyAuLi5cblx0XHR9XG5cdFx0cmV0dXJuIGV4cG9ydHNcblx0fSlcbn0pXG4qL1xuZXhwb3J0IGRlZmF1bHQgKF8sIGN4KSA9PiB7XG5cdGNvbnN0IGFsbFVzZXMgPSBfLmRvVXNlcy5jb25jYXQoXy51c2VzLCBfLmRlYnVnVXNlcylcblx0Y29uc3QgYW1kTmFtZXMgPSBBcnJheUV4cHJlc3Npb24oQW1kRmlyc3RVc2VzLmNvbmNhdChcblx0XHRhbGxVc2VzLm1hcCh1c2UgPT4gTGl0ZXJhbChtYW5nbGVQYXRoKHVzZS5wYXRoKSkpKSlcblx0Y29uc3QgdXNlSWRlbnRpZmllcnMgPSBhbGxVc2VzLm1hcCh1c2VJZGVudGlmaWVyKVxuXHRjb25zdCBhbWRBcmdzID0gQW1kRmlyc3RBcmdzLmNvbmNhdCh1c2VJZGVudGlmaWVycylcblx0Y29uc3QgdXNlRG9zID0gXy5kb1VzZXMubWFwKCh1c2UsIGkpID0+IHtcblx0XHRjb25zdCBkID0gRXhwcmVzc2lvblN0YXRlbWVudChtc0dldE1vZHVsZSh1c2VJZGVudGlmaWVyc1tpXSkpXG5cdFx0ZC5sb2MgPSB1c2UubG9jXG5cdFx0cmV0dXJuIGRcblx0fSlcblx0Y29uc3QgYWxsVXNlRGVjbGFyYXRvcnMgPSBmbGF0TWFwKF8udXNlcy5jb25jYXQoXy5kZWJ1Z1VzZXMpLCAodXNlLCBpKSA9PlxuXHRcdHVzZURlY2xhcmF0b3JzKGN4LCB1c2UsIHVzZUlkZW50aWZpZXJzW2kgKyBfLmRvVXNlcy5sZW5ndGhdKSlcblx0Y29uc3Qgb3BVc2VEZWNsYXJlID0gb3BJZighaXNFbXB0eShhbGxVc2VEZWNsYXJhdG9ycyksXG5cdFx0KCkgPT4gVmFyaWFibGVEZWNsYXJhdGlvbignY29uc3QnLCBhbGxVc2VEZWNsYXJhdG9ycykpXG5cblx0Ly8gVE9ETzogU29tZSB3YXkgb2YgZGV0ZXJtaW5pbmcgd2hlbiBpdCdzIE9LIGZvciBhIG1vZHVsZSB0byBub3QgYmUgbGF6eS5cblx0Y29uc3QgaXNMYXp5ID0gY3gub3B0cy5sYXp5TW9kdWxlKClcblxuXHRjb25zdCBsaW5lcyA9IGZsYXRNYXAoXy5saW5lcywgbGluZSA9PiB0b1N0YXRlbWVudHModG0obGluZSkpKVxuXG5cdGNvbnN0IG9wRGVmYXVsdEV4cG9ydCA9IG9wTWFwKF8ub3BEZWZhdWx0RXhwb3J0LCBfID0+XG5cdFx0QXNzaWdubWVudEV4cHJlc3Npb24oJz0nLCBFeHBvcnRzRGVmYXVsdCwgdDAoXykpKVxuXG5cdGNvbnN0IG1vZHVsZUJvZHkgPSBCbG9ja1N0YXRlbWVudChcblx0XHRjYXQodXNlRG9zLCBvcFVzZURlY2xhcmUsIGxpbmVzLCBvcERlZmF1bHRFeHBvcnQsIFsgUmV0dXJuRXhwb3J0cyBdKSlcblxuXHRjb25zdCBib2R5ID0gaXNMYXp5ID8gQmxvY2tTdGF0ZW1lbnQoWyBsYXp5Qm9keShtb2R1bGVCb2R5KSBdKSA6IG1vZHVsZUJvZHlcblxuXHRjb25zdCBkb0RlZmluZSA9IEV4cHJlc3Npb25TdGF0ZW1lbnQoXG5cdFx0Q2FsbEV4cHJlc3Npb24oSWREZWZpbmUsIFsgYW1kTmFtZXMsIEZ1bmN0aW9uRXhwcmVzc2lvbihudWxsLCBhbWRBcmdzLCBib2R5KSBdKSlcblxuXHRjb25zdCBvcFVzZVN0cmljdCA9IG9wSWYoY3gub3B0cy5pbmNsdWRlVXNlU3RyaWN0KCksICgpID0+IFVzZVN0cmljdClcblx0Y29uc3Qgb3BBbWRlZmluZSA9IG9wSWYoY3gub3B0cy5hbWRlZmluZSgpLCAoKSA9PiBBbWRlZmluZUhlYWRlcilcblxuXHRyZXR1cm4gUHJvZ3JhbShjYXQob3BVc2VTdHJpY3QsIG9wQW1kZWZpbmUsIGRvRGVmaW5lKSlcbn1cblxuY29uc3QgdXNlRGVjbGFyYXRvcnMgPSAoY3gsIF8sIG1vZHVsZUlkZW50aWZpZXIpID0+IHtcblx0Ly8gVE9ETzogQ291bGQgYmUgbmVhdGVyIGFib3V0IHRoaXNcblx0Y29uc3QgaXNMYXp5ID0gKGlzRW1wdHkoXy51c2VkKSA/IF8ub3BVc2VEZWZhdWx0IDogXy51c2VkWzBdKS5pc0xhenlcblx0Y29uc3QgdmFsdWUgPSAoaXNMYXp5ID8gbXNMYXp5R2V0TW9kdWxlIDogbXNHZXRNb2R1bGUpKG1vZHVsZUlkZW50aWZpZXIpXG5cblx0Y29uc3QgdXNlZERlZmF1bHQgPSBvcE1hcChfLm9wVXNlRGVmYXVsdCwgZGVmID0+IHtcblx0XHRjb25zdCBkZWZleHAgPSBtc0dldERlZmF1bHRFeHBvcnQobW9kdWxlSWRlbnRpZmllcilcblx0XHRjb25zdCB2YWwgPSBpc0xhenkgPyBsYXp5V3JhcChkZWZleHApIDogZGVmZXhwXG5cdFx0Y29uc3QgdmQgPSBWYXJpYWJsZURlY2xhcmF0b3IoaWRGb3JEZWNsYXJlQ2FjaGVkKGRlZiksIHZhbClcblx0XHR2ZC5sb2MgPSBkZWYubG9jXG5cdFx0cmV0dXJuIHZkXG5cdH0pXG5cblx0Y29uc3QgdXNlZERlc3RydWN0ID0gaXNFbXB0eShfLnVzZWQpID8gbnVsbCA6XG5cdFx0bWFrZURlc3RydWN0dXJlRGVjbGFyYXRvcnMoY3gsIF8ubG9jLCBfLnVzZWQsIGlzTGF6eSwgdmFsdWUsIHRydWUsIGZhbHNlKVxuXG5cdHJldHVybiBjYXQodXNlZERlZmF1bHQsIHVzZWREZXN0cnVjdClcbn1cblxuY29uc3Rcblx0dXNlSWRlbnRpZmllciA9ICh1c2UsIGkpID0+IGlkQ2FjaGVkKGAke2xhc3QodXNlLnBhdGguc3BsaXQoJy8nKSl9XyR7aX1gKSxcblxuXHRsYXp5Qm9keSA9IGJvZHkgPT5cblx0XHRFeHByZXNzaW9uU3RhdGVtZW50KFxuXHRcdFx0YXNzaWdubWVudEV4cHJlc3Npb25QbGFpbihtZW1iZXIoSWRFeHBvcnRzLCAnX2dldCcpLCBtc0xhenkoXG5cdFx0XHRcdEZ1bmN0aW9uRXhwcmVzc2lvbihudWxsLCBbIF0sIGJvZHkpKSkpLFxuXG5cdC8vIGlmICh0eXBlb2YgZGVmaW5lICE9PSAnZnVuY3Rpb24nKSB2YXIgZGVmaW5lID0gcmVxdWlyZSgnYW1kZWZpbmUnKShtb2R1bGUpXG5cdEFtZGVmaW5lSGVhZGVyID0gSWZTdGF0ZW1lbnQoXG5cdFx0QmluYXJ5RXhwcmVzc2lvbignIT09JywgVW5hcnlFeHByZXNzaW9uKCd0eXBlb2YnLCBJZERlZmluZSksIExpdGVyYWwoJ2Z1bmN0aW9uJykpLFxuXHRcdFZhcmlhYmxlRGVjbGFyYXRpb24oJ3ZhcicsIFtcblx0XHRcdFZhcmlhYmxlRGVjbGFyYXRvcihJZERlZmluZSwgQ2FsbEV4cHJlc3Npb24oXG5cdFx0XHRcdENhbGxFeHByZXNzaW9uKElkZW50aWZpZXIoJ3JlcXVpcmUnKSwgWyBMaXRlcmFsKCdhbWRlZmluZScpIF0pLFxuXHRcdFx0XHRbIElkTW9kdWxlIF0pKSBdKSksXG5cblx0VXNlU3RyaWN0ID0gRXhwcmVzc2lvblN0YXRlbWVudChMaXRlcmFsKCd1c2Ugc3RyaWN0JykpLFxuXG5cdFJldHVybkV4cG9ydHMgPSBSZXR1cm5TdGF0ZW1lbnQoSWRFeHBvcnRzKSxcblxuXHRFeHBvcnRzRGVmYXVsdCA9IG1lbWJlcihJZEV4cG9ydHMsICdkZWZhdWx0JyksXG5cblx0QW1kRmlyc3RVc2VzID0gWyBMaXRlcmFsKCdleHBvcnRzJykgXSxcblx0QW1kRmlyc3RBcmdzID0gWyBJZEV4cG9ydHMgXVxuIl0sInNvdXJjZVJvb3QiOiIvc3JjIn0=