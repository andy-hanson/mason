if (typeof define !== 'function') var define = require('amdefine')(module);define(['exports', 'module', 'esast/dist/ast', 'esast/dist/util', 'esast/dist/specialize', '../manglePath', '../U/Bag', '../U/Op', './esast-util', './transpile', './util'], function (exports, module, _esastDistAst, _esastDistUtil, _esastDistSpecialize, _manglePath, _UBag, _UOp, _esastUtil, _transpile, _util) {
	'use strict';

	function _interopRequire(obj) { return obj && obj.__esModule ? obj['default'] : obj; }

	var _manglePath2 = _interopRequire(_manglePath);

	/*
 'use strict';
 if (typeof define !== 'function')
 	var define = require('amdefine')(module);
 define(['exports', 'a', 'b', 'c'], function(exports) {
 	// Fake exports -- just a getter.
 	exports._get = _ms.lazy(function() {
 		const exports = {} // Real exports
 		... imports ...
 		{
 			... exports ...
 		}
 		return exports
 	})
 })
 */

	module.exports = function (_, cx) {
		const allUses = _.doUses.concat(_.uses, _.debugUses);
		const amdNames = _esastDistAst.ArrayExpression(AmdFirstUses.concat(allUses.map(function (use) {
			return _esastDistAst.Literal(_manglePath2(use.path));
		})));
		const useIdentifiers = allUses.map(useIdentifier);
		const amdArgs = AmdFirstArgs.concat(useIdentifiers);
		const useDos = _.doUses.map(function (use, i) {
			const d = _esastDistAst.ExpressionStatement(_util.msGetModule(useIdentifiers[i]));
			d.loc = use.loc;
			return d;
		});
		const allUseDeclarators = _UBag.flatMap(_.uses.concat(_.debugUses), function (use, i) {
			return useDeclarators(cx, use, useIdentifiers[i + _.doUses.length]);
		});
		const opUseDeclare = _UOp.opIf(!_UBag.isEmpty(allUseDeclarators), function () {
			return _esastDistAst.VariableDeclaration('const', allUseDeclarators);
		});

		// TODO: Some way of determining when it's OK for a module to not be lazy.
		const isLazy = cx.opts.lazyModule();

		const lines = _UBag.flatMap(_.lines, function (line) {
			return _util.toStatements(_transpile.tm(line));
		});

		const opDefaultExport = _.opDefaultExport.map(function (_) {
			return _esastDistAst.AssignmentExpression('=', ExportsDefault, _transpile.t0(_));
		});

		const moduleBody = _esastDistAst.BlockStatement(useDos.concat(opUseDeclare, lines, opDefaultExport, [ReturnExports]));

		const body = isLazy ? _esastDistAst.BlockStatement([lazyBody(moduleBody)]) : moduleBody;

		const doDefine = _esastDistAst.ExpressionStatement(_esastDistAst.CallExpression(_util.IdDefine, [amdNames, _esastDistAst.FunctionExpression(null, amdArgs, body)]));

		const opUseStrict = _UOp.opIf(cx.opts.includeUseStrict(), function () {
			return UseStrict;
		});
		const opAmdefine = _UOp.opIf(cx.opts.amdefine(), function () {
			return AmdefineHeader;
		});

		return _esastDistAst.Program(opUseStrict.concat(opAmdefine, [doDefine]));
	};

	const useDeclarators = function (cx, _, moduleIdentifier) {
		// TODO: Could be neater about this
		const isLazy = (_UBag.isEmpty(_.used) ? _.opUseDefault[0] : _.used[0]).isLazy;
		const value = (isLazy ? _util.msLazyGetModule : _util.msGetModule)(moduleIdentifier);

		const usedDefault = _.opUseDefault.map(function (def) {
			const defexp = _util.msGetDefaultExport(moduleIdentifier);
			const val = isLazy ? _util.lazyWrap(defexp) : defexp;
			const vd = _esastDistAst.VariableDeclarator(_esastUtil.idForDeclareCached(def), val);
			vd.loc = def.loc;
			return vd;
		});

		const usedDestruct = _UBag.isEmpty(_.used) ? [] : _util.makeDestructureDeclarators(cx, _.loc, _.used, isLazy, value, true, false);
		usedDestruct.forEach(function (_) {
			return _.loc = _.loc;
		});

		return usedDefault.concat(usedDestruct);
	};

	const useIdentifier = function (use, i) {
		return _esastDistUtil.idCached('' + _UBag.last(use.path.split('/')) + '_' + i);
	},
	      lazyBody = function (body) {
		return _esastDistAst.ExpressionStatement(_esastDistSpecialize.assignmentExpressionPlain(_esastDistUtil.member(_util.IdExports, '_get'), _util.msLazy(_esastDistAst.FunctionExpression(null, [], body))));
	},
	     

	// if (typeof define !== 'function') var define = require('amdefine')(module)
	AmdefineHeader = _esastDistAst.IfStatement(_esastDistAst.BinaryExpression('!==', _esastDistAst.UnaryExpression('typeof', _util.IdDefine), _esastDistAst.Literal('function')), _esastDistAst.VariableDeclaration('var', [_esastDistAst.VariableDeclarator(_util.IdDefine, _esastDistAst.CallExpression(_esastDistAst.CallExpression(_esastDistAst.Identifier('require'), [_esastDistAst.Literal('amdefine')]), [_util.IdModule]))])),
	      UseStrict = _esastDistAst.ExpressionStatement(_esastDistAst.Literal('use strict')),
	      ReturnExports = _esastDistAst.ReturnStatement(_util.IdExports),
	      ExportsDefault = _esastDistUtil.member(_util.IdExports, 'default'),
	      AmdFirstUses = [_esastDistAst.Literal('exports')],
	      AmdFirstArgs = [_util.IdExports];
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1ldGEvY29tcGlsZS9wcml2YXRlL3RyYW5zcGlsZS90cmFuc3BpbGVNb2R1bGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2tCQThCZSxVQUFDLENBQUMsRUFBRSxFQUFFLEVBQUs7QUFDekIsUUFBTSxPQUFPLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUE7QUFDcEQsUUFBTSxRQUFRLEdBQUcsY0FoQ1QsZUFBZSxDQWdDVSxZQUFZLENBQUMsTUFBTSxDQUNuRCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUEsR0FBRztVQUFJLGNBaEM4QyxPQUFPLENBZ0M3QyxhQUFXLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztHQUFBLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDcEQsUUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUNqRCxRQUFNLE9BQU8sR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBQ25ELFFBQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFVBQUMsR0FBRyxFQUFFLENBQUMsRUFBSztBQUN2QyxTQUFNLENBQUMsR0FBRyxjQXBDQyxtQkFBbUIsQ0FvQ0EsTUF6QmpCLFdBQVcsQ0F5QmtCLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDN0QsSUFBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFBO0FBQ2YsVUFBTyxDQUFDLENBQUE7R0FDUixDQUFDLENBQUE7QUFDRixRQUFNLGlCQUFpQixHQUFHLE1BbENsQixPQUFPLENBa0NtQixDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEVBQUUsVUFBQyxHQUFHLEVBQUUsQ0FBQztV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RUFBRSxjQWhHUixlQUFlLENBZ0dTLFFBQVEsUUF2RnpDLFFBQVEsQ0F1RjRDLEVBQUUsY0FqR0ksT0FBTyxDQWlHSCxVQUFVLENBQUMsQ0FBQyxFQUNqRixjQWpHaUMsbUJBQW1CLENBaUdoQyxLQUFLLEVBQUUsQ0FDMUIsY0FsR3FELGtCQUFrQixPQVNqRSxRQUFRLEVBeUZlLGNBcEdrRCxjQUFjLENBcUc1RixjQXJHOEUsY0FBYyxDQXFHN0UsY0FwR2xCLFVBQVUsQ0FvR21CLFNBQVMsQ0FBQyxFQUFFLENBQUUsY0FwR3VCLE9BQU8sQ0FvR3RCLFVBQVUsQ0FBQyxDQUFFLENBQUMsRUFDOUQsT0EzRjBCLFFBQVEsQ0EyRnRCLENBQUMsQ0FBQyxDQUFFLENBQUMsQ0FBQztPQUVyQixTQUFTLEdBQUcsY0F2R0EsbUJBQW1CLENBdUdDLGNBdkdrQyxPQUFPLENBdUdqQyxZQUFZLENBQUMsQ0FBQztPQUV0RCxhQUFhLEdBQUcsY0F4R2hCLGVBQWUsT0FTRyxTQUFTLENBK0ZlO09BRTFDLGNBQWMsR0FBRyxlQXhHQyxNQUFNLE9BT04sU0FBUyxFQWlHUSxTQUFTLENBQUM7T0FFN0MsWUFBWSxHQUFHLENBQUUsY0E3R2lELE9BQU8sQ0E2R2hELFNBQVMsQ0FBQyxDQUFFO09BQ3JDLFlBQVksR0FBRyxPQXBHRyxTQUFTLENBb0dDLENBQUEiLCJmaWxlIjoibWV0YS9jb21waWxlL3ByaXZhdGUvdHJhbnNwaWxlL3RyYW5zcGlsZU1vZHVsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFycmF5RXhwcmVzc2lvbiwgQXNzaWdubWVudEV4cHJlc3Npb24sIEJpbmFyeUV4cHJlc3Npb24sIEJsb2NrU3RhdGVtZW50LCBDYWxsRXhwcmVzc2lvbixcblx0SWRlbnRpZmllciwgRXhwcmVzc2lvblN0YXRlbWVudCwgRnVuY3Rpb25FeHByZXNzaW9uLCBJZlN0YXRlbWVudCwgTGl0ZXJhbCwgUHJvZ3JhbSxcblx0UmV0dXJuU3RhdGVtZW50LCBVbmFyeUV4cHJlc3Npb24sIFZhcmlhYmxlRGVjbGFyYXRpb24sIFZhcmlhYmxlRGVjbGFyYXRvclxuXHR9IGZyb20gJ2VzYXN0L2Rpc3QvYXN0J1xuaW1wb3J0IHsgaWRDYWNoZWQsIG1lbWJlciB9IGZyb20gJ2VzYXN0L2Rpc3QvdXRpbCdcbmltcG9ydCB7IGFzc2lnbm1lbnRFeHByZXNzaW9uUGxhaW4gfSBmcm9tICdlc2FzdC9kaXN0L3NwZWNpYWxpemUnXG5pbXBvcnQgbWFuZ2xlUGF0aCBmcm9tICcuLi9tYW5nbGVQYXRoJ1xuaW1wb3J0IHsgZmxhdE1hcCwgaXNFbXB0eSwgbGFzdCB9IGZyb20gJy4uL1UvQmFnJ1xuaW1wb3J0IHsgb3BJZiB9IGZyb20gJy4uL1UvT3AnXG5pbXBvcnQgeyBpZEZvckRlY2xhcmVDYWNoZWQgfSBmcm9tICcuL2VzYXN0LXV0aWwnXG5pbXBvcnQgeyB0MCwgdG0gfSBmcm9tICcuL3RyYW5zcGlsZSdcbmltcG9ydCB7IElkRGVmaW5lLCBJZEV4cG9ydHMsIElkTW9kdWxlLCBsYXp5V3JhcCwgbWFrZURlc3RydWN0dXJlRGVjbGFyYXRvcnMsXG5cdHRvU3RhdGVtZW50cywgbXNHZXRNb2R1bGUsIG1zTGF6eUdldE1vZHVsZSwgbXNHZXREZWZhdWx0RXhwb3J0LCBtc0xhenkgfSBmcm9tICcuL3V0aWwnXG5cbi8qXG4ndXNlIHN0cmljdCc7XG5pZiAodHlwZW9mIGRlZmluZSAhPT0gJ2Z1bmN0aW9uJylcblx0dmFyIGRlZmluZSA9IHJlcXVpcmUoJ2FtZGVmaW5lJykobW9kdWxlKTtcbmRlZmluZShbJ2V4cG9ydHMnLCAnYScsICdiJywgJ2MnXSwgZnVuY3Rpb24oZXhwb3J0cykge1xuXHQvLyBGYWtlIGV4cG9ydHMgLS0ganVzdCBhIGdldHRlci5cblx0ZXhwb3J0cy5fZ2V0ID0gX21zLmxhenkoZnVuY3Rpb24oKSB7XG5cdFx0Y29uc3QgZXhwb3J0cyA9IHt9IC8vIFJlYWwgZXhwb3J0c1xuXHRcdC4uLiBpbXBvcnRzIC4uLlxuXHRcdHtcblx0XHRcdC4uLiBleHBvcnRzIC4uLlxuXHRcdH1cblx0XHRyZXR1cm4gZXhwb3J0c1xuXHR9KVxufSlcbiovXG5leHBvcnQgZGVmYXVsdCAoXywgY3gpID0+IHtcblx0Y29uc3QgYWxsVXNlcyA9IF8uZG9Vc2VzLmNvbmNhdChfLnVzZXMsIF8uZGVidWdVc2VzKVxuXHRjb25zdCBhbWROYW1lcyA9IEFycmF5RXhwcmVzc2lvbihBbWRGaXJzdFVzZXMuY29uY2F0KFxuXHRcdGFsbFVzZXMubWFwKHVzZSA9PiBMaXRlcmFsKG1hbmdsZVBhdGgodXNlLnBhdGgpKSkpKVxuXHRjb25zdCB1c2VJZGVudGlmaWVycyA9IGFsbFVzZXMubWFwKHVzZUlkZW50aWZpZXIpXG5cdGNvbnN0IGFtZEFyZ3MgPSBBbWRGaXJzdEFyZ3MuY29uY2F0KHVzZUlkZW50aWZpZXJzKVxuXHRjb25zdCB1c2VEb3MgPSBfLmRvVXNlcy5tYXAoKHVzZSwgaSkgPT4ge1xuXHRcdGNvbnN0IGQgPSBFeHByZXNzaW9uU3RhdGVtZW50KG1zR2V0TW9kdWxlKHVzZUlkZW50aWZpZXJzW2ldKSlcblx0XHRkLmxvYyA9IHVzZS5sb2Ncblx0XHRyZXR1cm4gZFxuXHR9KVxuXHRjb25zdCBhbGxVc2VEZWNsYXJhdG9ycyA9IGZsYXRNYXAoXy51c2VzLmNvbmNhdChfLmRlYnVnVXNlcyksICh1c2UsIGkpID0+XG5cdFx0dXNlRGVjbGFyYXRvcnMoY3gsIHVzZSwgdXNlSWRlbnRpZmllcnNbaSArIF8uZG9Vc2VzLmxlbmd0aF0pKVxuXHRjb25zdCBvcFVzZURlY2xhcmUgPSBvcElmKCFpc0VtcHR5KGFsbFVzZURlY2xhcmF0b3JzKSxcblx0XHQoKSA9PiBWYXJpYWJsZURlY2xhcmF0aW9uKCdjb25zdCcsIGFsbFVzZURlY2xhcmF0b3JzKSlcblxuXHQvLyBUT0RPOiBTb21lIHdheSBvZiBkZXRlcm1pbmluZyB3aGVuIGl0J3MgT0sgZm9yIGEgbW9kdWxlIHRvIG5vdCBiZSBsYXp5LlxuXHRjb25zdCBpc0xhenkgPSBjeC5vcHRzLmxhenlNb2R1bGUoKVxuXG5cdGNvbnN0IGxpbmVzID0gZmxhdE1hcChfLmxpbmVzLCBsaW5lID0+IHRvU3RhdGVtZW50cyh0bShsaW5lKSkpXG5cblx0Y29uc3Qgb3BEZWZhdWx0RXhwb3J0ID0gXy5vcERlZmF1bHRFeHBvcnQubWFwKF8gPT5cblx0XHRBc3NpZ25tZW50RXhwcmVzc2lvbignPScsIEV4cG9ydHNEZWZhdWx0LCB0MChfKSkpXG5cblx0Y29uc3QgbW9kdWxlQm9keSA9IEJsb2NrU3RhdGVtZW50KFxuXHRcdHVzZURvcy5jb25jYXQob3BVc2VEZWNsYXJlLCBsaW5lcywgb3BEZWZhdWx0RXhwb3J0LCBbIFJldHVybkV4cG9ydHMgXSkpXG5cblx0Y29uc3QgYm9keSA9IGlzTGF6eSA/IEJsb2NrU3RhdGVtZW50KFsgbGF6eUJvZHkobW9kdWxlQm9keSkgXSkgOiBtb2R1bGVCb2R5XG5cblx0Y29uc3QgZG9EZWZpbmUgPSBFeHByZXNzaW9uU3RhdGVtZW50KFxuXHRcdENhbGxFeHByZXNzaW9uKElkRGVmaW5lLCBbIGFtZE5hbWVzLCBGdW5jdGlvbkV4cHJlc3Npb24obnVsbCwgYW1kQXJncywgYm9keSkgXSkpXG5cblx0Y29uc3Qgb3BVc2VTdHJpY3QgPSBvcElmKGN4Lm9wdHMuaW5jbHVkZVVzZVN0cmljdCgpLCAoKSA9PiBVc2VTdHJpY3QpXG5cdGNvbnN0IG9wQW1kZWZpbmUgPSBvcElmKGN4Lm9wdHMuYW1kZWZpbmUoKSwgKCkgPT4gQW1kZWZpbmVIZWFkZXIpXG5cblx0cmV0dXJuIFByb2dyYW0ob3BVc2VTdHJpY3QuY29uY2F0KG9wQW1kZWZpbmUsIFsgZG9EZWZpbmUgXSkpXG59XG5cbmNvbnN0IHVzZURlY2xhcmF0b3JzID0gKGN4LCBfLCBtb2R1bGVJZGVudGlmaWVyKSA9PiB7XG5cdC8vIFRPRE86IENvdWxkIGJlIG5lYXRlciBhYm91dCB0aGlzXG5cdGNvbnN0IGlzTGF6eSA9IChpc0VtcHR5KF8udXNlZCkgPyBfLm9wVXNlRGVmYXVsdFswXSA6IF8udXNlZFswXSkuaXNMYXp5XG5cdGNvbnN0IHZhbHVlID0gKGlzTGF6eSA/IG1zTGF6eUdldE1vZHVsZSA6IG1zR2V0TW9kdWxlKShtb2R1bGVJZGVudGlmaWVyKVxuXG5cdGNvbnN0IHVzZWREZWZhdWx0ID0gXy5vcFVzZURlZmF1bHQubWFwKGRlZiA9PiB7XG5cdFx0Y29uc3QgZGVmZXhwID0gbXNHZXREZWZhdWx0RXhwb3J0KG1vZHVsZUlkZW50aWZpZXIpXG5cdFx0Y29uc3QgdmFsID0gaXNMYXp5ID8gbGF6eVdyYXAoZGVmZXhwKSA6IGRlZmV4cFxuXHRcdGNvbnN0IHZkID0gVmFyaWFibGVEZWNsYXJhdG9yKGlkRm9yRGVjbGFyZUNhY2hlZChkZWYpLCB2YWwpXG5cdFx0dmQubG9jID0gZGVmLmxvY1xuXHRcdHJldHVybiB2ZFxuXHR9KVxuXG5cdGNvbnN0IHVzZWREZXN0cnVjdCA9IGlzRW1wdHkoXy51c2VkKSA/IFsgXSA6XG5cdFx0bWFrZURlc3RydWN0dXJlRGVjbGFyYXRvcnMoY3gsIF8ubG9jLCBfLnVzZWQsIGlzTGF6eSwgdmFsdWUsIHRydWUsIGZhbHNlKVxuXHR1c2VkRGVzdHJ1Y3QuZm9yRWFjaChfID0+IF8ubG9jID0gXy5sb2MpXG5cblx0cmV0dXJuIHVzZWREZWZhdWx0LmNvbmNhdCh1c2VkRGVzdHJ1Y3QpXG59XG5cbmNvbnN0XG5cdHVzZUlkZW50aWZpZXIgPSAodXNlLCBpKSA9PiBpZENhY2hlZChgJHtsYXN0KHVzZS5wYXRoLnNwbGl0KCcvJykpfV8ke2l9YCksXG5cblx0bGF6eUJvZHkgPSBib2R5ID0+XG5cdFx0RXhwcmVzc2lvblN0YXRlbWVudChcblx0XHRcdGFzc2lnbm1lbnRFeHByZXNzaW9uUGxhaW4obWVtYmVyKElkRXhwb3J0cywgJ19nZXQnKSwgbXNMYXp5KFxuXHRcdFx0XHRGdW5jdGlvbkV4cHJlc3Npb24obnVsbCwgWyBdLCBib2R5KSkpKSxcblxuXHQvLyBpZiAodHlwZW9mIGRlZmluZSAhPT0gJ2Z1bmN0aW9uJykgdmFyIGRlZmluZSA9IHJlcXVpcmUoJ2FtZGVmaW5lJykobW9kdWxlKVxuXHRBbWRlZmluZUhlYWRlciA9IElmU3RhdGVtZW50KFxuXHRcdEJpbmFyeUV4cHJlc3Npb24oJyE9PScsIFVuYXJ5RXhwcmVzc2lvbigndHlwZW9mJywgSWREZWZpbmUpLCBMaXRlcmFsKCdmdW5jdGlvbicpKSxcblx0XHRWYXJpYWJsZURlY2xhcmF0aW9uKCd2YXInLCBbXG5cdFx0XHRWYXJpYWJsZURlY2xhcmF0b3IoSWREZWZpbmUsIENhbGxFeHByZXNzaW9uKFxuXHRcdFx0XHRDYWxsRXhwcmVzc2lvbihJZGVudGlmaWVyKCdyZXF1aXJlJyksIFsgTGl0ZXJhbCgnYW1kZWZpbmUnKSBdKSxcblx0XHRcdFx0WyBJZE1vZHVsZSBdKSkgXSkpLFxuXG5cdFVzZVN0cmljdCA9IEV4cHJlc3Npb25TdGF0ZW1lbnQoTGl0ZXJhbCgndXNlIHN0cmljdCcpKSxcblxuXHRSZXR1cm5FeHBvcnRzID0gUmV0dXJuU3RhdGVtZW50KElkRXhwb3J0cyksXG5cblx0RXhwb3J0c0RlZmF1bHQgPSBtZW1iZXIoSWRFeHBvcnRzLCAnZGVmYXVsdCcpLFxuXG5cdEFtZEZpcnN0VXNlcyA9IFsgTGl0ZXJhbCgnZXhwb3J0cycpIF0sXG5cdEFtZEZpcnN0QXJncyA9IFsgSWRFeHBvcnRzIF1cbiJdLCJzb3VyY2VSb290IjoiL3NyYyJ9