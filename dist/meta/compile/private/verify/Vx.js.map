{"version":3,"sources":["meta/compile/private/verify/Vx.js"],"names":[],"mappings":"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","file":"meta/compile/private/verify/Vx.js","sourcesContent":["import { code } from '../../CompileError'\nimport { GlobalDeclare, LocalDeclare } from '../../Expression'\nimport { SubContext } from '../Cx'\nimport { JsGlobals } from '../Lang'\nimport Opts from '../Opts'\nimport { assert } from '../U/util'\nimport { isEmpty, toArray } from '../U/Bag'\nimport Op, { None, opIf, some } from '../U/Op'\nimport type from '../U/type'\nimport { ObjType } from '../U/types'\nimport Vr, { emptyVr, VrLocalInfo } from '../Vr'\n\n// Context used during verification.\nexport default class Vx extends SubContext {\n\tconstructor(cx) {\n\t\tsuper(cx)\n\t\tthis.locals = new Map()\n\t\t// Locals for this block.\n\t\t// Replaces `locals` when entering into sub-function.\n\t\tthis.pendingBlockLocals = []\n\t\tthis.isInDebug = false\n\t\tthis.isInGenerator = false\n\t\tthis.opLoop = []\n\t\tthis.vr = emptyVr()\n\t}\n\n\t// Getters\n\tallLocalNames() {\n\t\treturn this.locals.keys()\n\t}\n\n\t// Modifiers\n\twithInGenerator(isInGenerator, fun) {\n\t\tconst g = this.isInGenerator\n\t\tthis.isInGenerator = isInGenerator\n\t\tfun()\n\t\tthis.isInGenerator = g\n\t}\n\tplusLocals(addedLocals, fun) {\n\t\ttype(addedLocals, [LocalDeclare])\n\t\tconst shadowed = new Map()\n\t\taddedLocals.forEach(l => {\n\t\t\tconst got = this.locals.get(l.name)\n\t\t\tif (got !== undefined)\n\t\t\t\tshadowed.set(l.name, got)\n\t\t\tthis.locals.set(l.name, l)\n\t\t})\n\t\tfun()\n\t\taddedLocals.forEach(l => {\n\t\t\tthis.locals.delete(l.name)\n\t\t\tconst s = shadowed.get(l.name)\n\t\t\tif (s !== undefined)\n\t\t\t\tthis.locals.set(l.name, s)\n\t\t})\n\t}\n\tplusPendingBlockLocals(pending, fun) {\n\t\tconst oldLength = this.pendingBlockLocals.length\n\t\tthis.pendingBlockLocals.push(...pending)\n\t\tfun()\n\t\twhile (this.pendingBlockLocals.length > oldLength)\n\t\t\tthis.pendingBlockLocals.pop()\n\t}\n\twithInLoop(loop, fun) {\n\t\tconst l = this.opLoop\n\t\tthis.opLoop = some(loop)\n\t\tfun()\n\t\tthis.opLoop = l\n\t}\n\twithInDebug(isInDebug, fun) {\n\t\tconst d = this.isInDebug\n\t\tthis.isInDebug = isInDebug\n\t\tfun()\n\t\tthis.isInDebug = d\n\t}\n\twithRes(loc, fun) {\n\t\t// TODO: Bad idea to be creating new E at this point...\n\t\tconst res = LocalDeclare.res(loc)\n\t\tthis.registerLocal(res)\n\t\treturn this.plusLocals([ res ], fun)\n\t}\n\twithBlockLocals(fun) {\n\t\tconst bl = this.pendingBlockLocals\n\t\tthis.pendingBlockLocals = []\n\t\tthis.plusLocals(bl, fun)\n\t\tthis.pendingBlockLocals = bl\n\t}\n\n\t// Vr setters\n\tsetEndLoop(endLoop, loop) {\n\t\tthis.vr.endLoopToLoop.set(endLoop, loop)\n\t}\n\t// TODO: Better name\n\tsetEIsInGenerator(e) {\n\t\tthis.vr.setEIsInGenerator(e, this.isInGenerator)\n\t}\n\tregisterLocal(local) {\n\t\ttype(local, LocalDeclare)\n\t\tassert(!this.vr.localToInfo.has(local))\n\t\tthis.vr.localToInfo.set(local, VrLocalInfo({\n\t\t\tisInDebug: this.isInDebug,\n\t\t\tdebugAccesses: [],\n\t\t\tnonDebugAccesses: []\n\t\t}))\n\t}\n\n\tlocalAccess(access) {\n\t\tconst name = access.name\n\t\tconst local = this.locals.get(name)\n\t\tif (local !== undefined) {\n\t\t\tthis.vr.accessToLocal.set(access, local)\n\t\t\tconst info = this.vr.localToInfo.get(local)\n\t\t\tconst accesses = this.isInDebug ? info.debugAccesses : info.nonDebugAccesses\n\t\t\taccesses.push(access)\n\t\t} else\n\t\t\tthis.fail(access.loc,\n\t\t\t\t`Could not find local or global ${code(name)}.\\n` +\n\t\t\t\t'Available locals are:\\n' +\n\t\t\t\t`${code(toArray(this.allLocalNames()).join(' '))}.`)\n\t}\n}\n"],"sourceRoot":"/src"}