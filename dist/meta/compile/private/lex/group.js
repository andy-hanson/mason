if (typeof define !== 'function') var define = require('amdefine')(module);define(['exports', 'module', 'esast/dist/Loc', '../Token', '../util', './GroupPre'], function (exports, module, _esastDistLoc, _Token, _util, _GroupPre) {
	'use strict';

	module.exports = group;

	function _interopRequire(obj) { return obj && obj.__esModule ? obj['default'] : obj; }

	var _Loc = _interopRequire(_esastDistLoc);

	var _GroupPre2 = _interopRequire(_GroupPre);

	function group(cx, preGroupedTokens) {
		// Stack of GroupBuilders
		const stack = [];
		let cur;

		const newLevel = function (pos, k) {
			stack.push(cur);
			cur = (0, _Token.Group)((0, _Loc)(pos, null), [], k);
		},
		      finishLevels = function (closePos, k) {
			// We may close other groups. For example, a G_Line can close a G_Paren.
			while (true) {
				const close = (0, _GroupPre.groupOpenToClose)(cur.kind);
				if (close === k) break;else {
					cx.check(cur.kind === _GroupPre.GP_OpenParen || cur.kind === _GroupPre.GP_OpenBracket || cur.kind === _GroupPre.GP_Space, closePos, function () {
						return 'Trying to close ' + showG(k) + ', but last opened was ' + showG(cur.kind);
					});
					finishLevel(closePos, close);
				}
			}
			finishLevel(closePos, k);
		},
		      finishLevel = function (closePos, k) {
			let wrapped = wrapLevel(closePos);
			// cur is now the previous level on the stack
			// Don't add line/spaced
			switch (k) {
				case _GroupPre.GP_Space:
					{
						const size = wrapped.tokens.length;
						if (size === 0) return;else if (size === 1)
							// Spaced should always have at least two elements
							wrapped = wrapped.tokens[0];
						break;
					}
				case _GroupPre.GP_Line:
					if ((0, _util.isEmpty)(wrapped.tokens)) return;
					break;
				case _GroupPre.GP_CloseBlock:
					if ((0, _util.isEmpty)(wrapped.tokens)) cx.fail(closePos, 'Empty block');
				default:
				// fallthrough
			}
			cur.tokens.push(wrapped);
		},
		      wrapLevel = function (closePos) {
			const builtGroup = cur;
			cur = stack.pop();
			builtGroup.loc.end = closePos;
			return builtGroup;
		},
		      startLine = function (pos) {
			newLevel(pos, _GroupPre.GP_Line);
			newLevel(pos, _GroupPre.GP_Space);
		},
		      endLine = function (pos) {
			finishLevels(pos, _GroupPre.GP_Space);
			finishLevels(pos, _GroupPre.GP_Line);
		},
		      endAndStart = function (loc, k) {
			finishLevels(loc.start, k);
			newLevel(loc.end, k);
		};

		cur = (0, _Token.Group)((0, _Loc)(_esastDistLoc.StartPos, null), [], _GroupPre.GP_OpenBlock);
		startLine(_esastDistLoc.StartPos);

		let endLoc = (0, _Loc)(_esastDistLoc.StartPos, _esastDistLoc.StartPos);
		preGroupedTokens.forEach(function (_) {
			if (_ instanceof _GroupPre2) {
				// It's a GroupPre
				const loc = _.loc;
				endLoc = loc;
				const kind = _.kind;
				switch (kind) {
					case _GroupPre.GP_OpenParen:case _GroupPre.GP_OpenBracket:
						newLevel(loc.start, kind);
						newLevel(loc.end, _GroupPre.GP_Space);
						break;
					case _GroupPre.GP_CloseParen:case _GroupPre.GP_CloseBracket:
						finishLevels(loc.end, kind);
						break;
					case _GroupPre.GP_OpenQuote:
						newLevel(loc.start, kind);
						break;
					case _GroupPre.GP_CloseQuote:
						finishLevels(loc.start, kind);
						break;
					case _GroupPre.GP_OpenBlock:
						//  ~ before block is OK
						if ((0, _util.isEmpty)(cur.tokens) || !(0, _Token.isKeyword)(_Token.KW_Lazy, (0, _util.last)(cur.tokens))) endAndStart(loc, _GroupPre.GP_Space);
						newLevel(loc.start, kind);
						startLine(loc.end);
						break;
					case _GroupPre.GP_CloseBlock:
						endLine(loc.start);
						finishLevels(loc.end, kind);
						break;
					case _GroupPre.GP_Line:
						endLine(loc.start);
						startLine(loc.end);
						break;
					case _GroupPre.GP_Space:
						endAndStart(loc, kind);
						break;
					default:
						throw new Error(kind);
				}
			} else cur.tokens.push(_);
		});

		endLine(endLoc.end);
		(0, _util.assert)((0, _util.isEmpty)(stack));
		cur.loc.end = endLoc.end;
		return cur;
	}

	// TODO
	const showG = function (kind) {
		return kind;
	};
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1ldGEvY29tcGlsZS9wcml2YXRlL2xleC9ncm91cC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7a0JBT3dCLEtBQUs7Ozs7Ozs7O0FBQWQsVUFBUyxLQUFLLENBQUMsRUFBRSxFQUFFLGdCQUFnQixFQUFFOztBQUVuRCxRQUFNLEtBQUssR0FBRyxFQUFFLENBQUE7QUFDaEIsTUFBSSxHQUFHLENBQUE7O0FBRVAsUUFDQyxRQUFRLEdBQUcsVUFBQyxHQUFHLEVBQUUsQ0FBQyxFQUFLO0FBQ3RCLFFBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDZixNQUFHLEdBQUcsV0FkQSxLQUFLLEVBY0MsVUFBSSxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRyxFQUFFLENBQUMsQ0FBQyxDQUFBO0dBQ25DO1FBRUQsWUFBWSxHQUFHLFVBQUMsUUFBUSxFQUFFLENBQUMsRUFBSzs7QUFFL0IsVUFBTyxJQUFJLEVBQUU7QUFDWixVQUFNLEtBQUssR0FBRyxjQWpCakIsZ0JBQWdCLEVBaUJrQixHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDeEMsUUFBSSxLQUFLLEtBQUssQ0FBQyxFQUNkLE1BQUssS0FDRDtBQUNKLE9BQUUsQ0FBQyxLQUFLLENBQ1AsR0FBRyxDQUFDLElBQUksZUF0QkssWUFBWSxBQXNCQSxJQUN4QixHQUFHLENBQUMsSUFBSSxlQXZCa0IsY0FBYyxBQXVCYixJQUMzQixHQUFHLENBQUMsSUFBSSxlQXZCZCxRQUFRLEFBdUJtQixFQUN0QixRQUFRLEVBQUU7a0NBQ1MsS0FBSyxDQUFDLENBQUMsQ0FBQyw4QkFBeUIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7TUFBRSxDQUFDLENBQUE7QUFDdkUsZ0JBQVcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUE7S0FDNUI7SUFDRDtBQUNELGNBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUE7R0FDeEI7UUFFRCxXQUFXLEdBQUcsVUFBQyxRQUFR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Q0FBQyxDQUFBO0dBQ25CLENBQUMsQ0FBQTs7QUFFRixTQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQ25CLFlBcElRLE1BQU0sRUFvSVAsVUFwSVMsT0FBTyxFQW9JUixLQUFLLENBQUMsQ0FBQyxDQUFBO0FBQ3RCLEtBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUE7QUFDeEIsU0FBTyxHQUFHLENBQUE7RUFDVjs7O0FBR0QsT0FBTSxLQUFLLEdBQUcsVUFBQSxJQUFJO1NBQUksSUFBSTtFQUFBLENBQUEiLCJmaWxlIjoibWV0YS9jb21waWxlL3ByaXZhdGUvbGV4L2dyb3VwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IExvYywgeyBTdGFydFBvcyB9IGZyb20gJ2VzYXN0L2Rpc3QvTG9jJ1xuaW1wb3J0IHsgR3JvdXAsIGlzS2V5d29yZCwgS1dfTGF6eSB9IGZyb20gJy4uL1Rva2VuJ1xuaW1wb3J0IHsgYXNzZXJ0LCBpc0VtcHR5LCBsYXN0IH0gZnJvbSAnLi4vdXRpbCdcbmltcG9ydCBHcm91cFByZSwge1xuXHRncm91cE9wZW5Ub0Nsb3NlLCBHUF9PcGVuUGFyZW4sIEdQX09wZW5CcmFja2V0LCBHUF9PcGVuQmxvY2ssIEdQX09wZW5RdW90ZSwgR1BfTGluZSxcblx0R1BfU3BhY2UsIEdQX0Nsb3NlUGFyZW4sIEdQX0Nsb3NlQnJhY2tldCwgR1BfQ2xvc2VCbG9jaywgR1BfQ2xvc2VRdW90ZX0gZnJvbSAnLi9Hcm91cFByZSdcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZ3JvdXAoY3gsIHByZUdyb3VwZWRUb2tlbnMpIHtcblx0Ly8gU3RhY2sgb2YgR3JvdXBCdWlsZGVyc1xuXHRjb25zdCBzdGFjayA9IFtdXG5cdGxldCBjdXJcblxuXHRjb25zdFxuXHRcdG5ld0xldmVsID0gKHBvcywgaykgPT4ge1xuXHRcdFx0c3RhY2sucHVzaChjdXIpXG5cdFx0XHRjdXIgPSBHcm91cChMb2MocG9zLCBudWxsKSwgWyBdLCBrKVxuXHRcdH0sXG5cblx0XHRmaW5pc2hMZXZlbHMgPSAoY2xvc2VQb3MsIGspID0+IHtcblx0XHRcdC8vIFdlIG1heSBjbG9zZSBvdGhlciBncm91cHMuIEZvciBleGFtcGxlLCBhIEdfTGluZSBjYW4gY2xvc2UgYSBHX1BhcmVuLlxuXHRcdFx0d2hpbGUgKHRydWUpIHtcblx0XHRcdFx0Y29uc3QgY2xvc2UgPSBncm91cE9wZW5Ub0Nsb3NlKGN1ci5raW5kKVxuXHRcdFx0XHRpZiAoY2xvc2UgPT09IGspXG5cdFx0XHRcdFx0YnJlYWtcblx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0Y3guY2hlY2soXG5cdFx0XHRcdFx0XHRjdXIua2luZCA9PT0gR1BfT3BlblBhcmVuIHx8XG5cdFx0XHRcdFx0XHRcdGN1ci5raW5kID09PSBHUF9PcGVuQnJhY2tldCB8fFxuXHRcdFx0XHRcdFx0XHRjdXIua2luZCA9PT0gR1BfU3BhY2UsXG5cdFx0XHRcdFx0XHRjbG9zZVBvcywgKCkgPT5cblx0XHRcdFx0XHRcdGBUcnlpbmcgdG8gY2xvc2UgJHtzaG93RyhrKX0sIGJ1dCBsYXN0IG9wZW5lZCB3YXMgJHtzaG93RyhjdXIua2luZCl9YClcblx0XHRcdFx0XHRmaW5pc2hMZXZlbChjbG9zZVBvcywgY2xvc2UpXG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdGZpbmlzaExldmVsKGNsb3NlUG9zLCBrKVxuXHRcdH0sXG5cblx0XHRmaW5pc2hMZXZlbCA9IChjbG9zZVBvcywgaykgPT4ge1xuXHRcdFx0bGV0IHdyYXBwZWQgPSB3cmFwTGV2ZWwoY2xvc2VQb3MpXG5cdFx0XHQvLyBjdXIgaXMgbm93IHRoZSBwcmV2aW91cyBsZXZlbCBvbiB0aGUgc3RhY2tcblx0XHRcdC8vIERvbid0IGFkZCBsaW5lL3NwYWNlZFxuXHRcdFx0c3dpdGNoIChrKSB7XG5cdFx0XHRcdGNhc2UgR1BfU3BhY2U6IHtcblx0XHRcdFx0XHRjb25zdCBzaXplID0gd3JhcHBlZC50b2tlbnMubGVuZ3RoXG5cdFx0XHRcdFx0aWYgKHNpemUgPT09IDApXG5cdFx0XHRcdFx0XHRyZXR1cm5cblx0XHRcdFx0XHRlbHNlIGlmIChzaXplID09PSAxKVxuXHRcdFx0XHRcdFx0Ly8gU3BhY2VkIHNob3VsZCBhbHdheXMgaGF2ZSBhdCBsZWFzdCB0d28gZWxlbWVudHNcblx0XHRcdFx0XHRcdHdyYXBwZWQgPSB3cmFwcGVkLnRva2Vuc1swXVxuXHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdH1cblx0XHRcdFx0Y2FzZSBHUF9MaW5lOlxuXHRcdFx0XHRcdGlmIChpc0VtcHR5KHdyYXBwZWQudG9rZW5zKSlcblx0XHRcdFx0XHRcdHJldHVyblxuXHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdGNhc2UgR1BfQ2xvc2VCbG9jazpcblx0XHRcdFx0XHRpZiAoaXNFbXB0eSh3cmFwcGVkLnRva2VucykpXG5cdFx0XHRcdFx0XHRjeC5mYWlsKGNsb3NlUG9zLCAnRW1wdHkgYmxvY2snKVxuXHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRcdC8vIGZhbGx0aHJvdWdoXG5cdFx0XHR9XG5cdFx0XHRjdXIudG9rZW5zLnB1c2god3JhcHBlZClcblx0XHR9LFxuXG5cdFx0d3JhcExldmVsID0gY2xvc2VQb3MgPT4ge1xuXHRcdFx0Y29uc3QgYnVpbHRHcm91cCA9IGN1clxuXHRcdFx0Y3VyID0gc3RhY2sucG9wKClcblx0XHRcdGJ1aWx0R3JvdXAubG9jLmVuZCA9IGNsb3NlUG9zXG5cdFx0XHRyZXR1cm4gYnVpbHRHcm91cFxuXHRcdH0sXG5cblx0XHRzdGFydExpbmUgPSBwb3MgPT4ge1xuXHRcdFx0bmV3TGV2ZWwocG9zLCBHUF9MaW5lKVxuXHRcdFx0bmV3TGV2ZWwocG9zLCBHUF9TcGFjZSlcblx0XHR9LFxuXHRcdGVuZExpbmUgPSBwb3MgPT4ge1xuXHRcdFx0ZmluaXNoTGV2ZWxzKHBvcywgR1BfU3BhY2UpXG5cdFx0XHRmaW5pc2hMZXZlbHMocG9zLCBHUF9MaW5lKVxuXHRcdH0sXG5cblx0XHRlbmRBbmRTdGFydCA9IChsb2MsIGspID0+IHtcblx0XHRcdGZpbmlzaExldmVscyhsb2Muc3RhcnQsIGspXG5cdFx0XHRuZXdMZXZlbChsb2MuZW5kLCBrKVxuXHRcdH1cblxuXHRjdXIgPSBHcm91cChMb2MoU3RhcnRQb3MsIG51bGwpLCBbIF0sIEdQX09wZW5CbG9jaylcblx0c3RhcnRMaW5lKFN0YXJ0UG9zKVxuXG5cdGxldCBlbmRMb2MgPSBMb2MoU3RhcnRQb3MsIFN0YXJ0UG9zKVxuXHRwcmVHcm91cGVkVG9rZW5zLmZvckVhY2goXyA9PiB7XG5cdFx0aWYgKF8gaW5zdGFuY2VvZiBHcm91cFByZSkge1xuXHRcdFx0Ly8gSXQncyBhIEdyb3VwUHJlXG5cdFx0XHRjb25zdCBsb2MgPSBfLmxvY1xuXHRcdFx0ZW5kTG9jID0gbG9jXG5cdFx0XHRjb25zdCBraW5kID0gXy5raW5kXG5cdFx0XHRzd2l0Y2ggKGtpbmQpIHtcblx0XHRcdFx0Y2FzZSBHUF9PcGVuUGFyZW46IGNhc2UgR1BfT3BlbkJyYWNrZXQ6XG5cdFx0XHRcdFx0bmV3TGV2ZWwobG9jLnN0YXJ0LCBraW5kKVxuXHRcdFx0XHRcdG5ld0xldmVsKGxvYy5lbmQsIEdQX1NwYWNlKVxuXHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdGNhc2UgR1BfQ2xvc2VQYXJlbjogY2FzZSBHUF9DbG9zZUJyYWNrZXQ6XG5cdFx0XHRcdFx0ZmluaXNoTGV2ZWxzKGxvYy5lbmQsIGtpbmQpXG5cdFx0XHRcdFx0YnJlYWtcblx0XHRcdFx0Y2FzZSBHUF9PcGVuUXVvdGU6XG5cdFx0XHRcdFx0bmV3TGV2ZWwobG9jLnN0YXJ0LCBraW5kKVxuXHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdGNhc2UgR1BfQ2xvc2VRdW90ZTpcblx0XHRcdFx0XHRmaW5pc2hMZXZlbHMobG9jLnN0YXJ0LCBraW5kKVxuXHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdGNhc2UgR1BfT3BlbkJsb2NrOlxuXHRcdFx0XHRcdC8vICB+IGJlZm9yZSBibG9jayBpcyBPS1xuXHRcdFx0XHRcdGlmIChpc0VtcHR5KGN1ci50b2tlbnMpIHx8ICFpc0tleXdvcmQoS1dfTGF6eSwgbGFzdChjdXIudG9rZW5zKSkpXG5cdFx0XHRcdFx0XHRlbmRBbmRTdGFydChsb2MsIEdQX1NwYWNlKVxuXHRcdFx0XHRcdG5ld0xldmVsKGxvYy5zdGFydCwga2luZClcblx0XHRcdFx0XHRzdGFydExpbmUobG9jLmVuZClcblx0XHRcdFx0XHRicmVha1xuXHRcdFx0XHRjYXNlIEdQX0Nsb3NlQmxvY2s6XG5cdFx0XHRcdFx0ZW5kTGluZShsb2Muc3RhcnQpXG5cdFx0XHRcdFx0ZmluaXNoTGV2ZWxzKGxvYy5lbmQsIGtpbmQpXG5cdFx0XHRcdFx0YnJlYWtcblx0XHRcdFx0Y2FzZSBHUF9MaW5lOlxuXHRcdFx0XHRcdGVuZExpbmUobG9jLnN0YXJ0KVxuXHRcdFx0XHRcdHN0YXJ0TGluZShsb2MuZW5kKVxuXHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdGNhc2UgR1BfU3BhY2U6XG5cdFx0XHRcdFx0ZW5kQW5kU3RhcnQobG9jLCBraW5kKVxuXHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcihraW5kKVxuXHRcdFx0fVxuXHRcdH0gZWxzZVxuXHRcdFx0Y3VyLnRva2Vucy5wdXNoKF8pXG5cdH0pXG5cblx0ZW5kTGluZShlbmRMb2MuZW5kKVxuXHRhc3NlcnQoaXNFbXB0eShzdGFjaykpXG5cdGN1ci5sb2MuZW5kID0gZW5kTG9jLmVuZFxuXHRyZXR1cm4gY3VyXG59XG5cbi8vIFRPRE9cbmNvbnN0IHNob3dHID0ga2luZCA9PiBraW5kXG4iXSwic291cmNlUm9vdCI6Ii9zcmMifQ==